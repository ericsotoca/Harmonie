
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord Personnel</title>
    <!-- Dépendances -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>

    <style>
        /* Styles Globaux (minimal) */
        body {
            /* Tailwind gère la plupart des styles de base */
            transition: background-color 0.3s, color 0.3s; /* Pour le thème Roue de la Vie */
        }

        /* Styles pour la navigation principale */
        .main-nav {
            background-color: #e2e8f0; /* gray-200 */
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #cbd5e1; /* gray-300 */
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .main-nav button {
            padding: 0.5rem 1rem;
            border: none;
            background-color: transparent;
            color: #475569; /* gray-600 */
            font-weight: 500;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .main-nav button:hover {
            background-color: #f1f5f9; /* gray-100 */
            color: #1e293b; /* gray-800 */
        }
        .main-nav button.active {
            background-color: #6366f1; /* indigo-500 */
            color: white;
        }

        /* Conteneurs d'application */
        .app-container {
            display: none; /* Caché par défaut */
            padding: 1rem; /* Un peu d'espace autour */
        }
        .app-container.active {
            display: block;
        }

        /* --- Styles préfixés pour App 1: Roue de la Vie --- */
        #app-wheel {
            /* Variables CSS spécifiques à la Roue, définies ici */
            --wheel-bg-color: #f4f4f4; --wheel-container-bg: white; --wheel-text-color: #2c3e50; --wheel-secondary-text-color: #34495e; --wheel-primary-color: #3498db; --wheel-primary-hover-color: #2980b9; --wheel-disabled-color: #bdc3c7; --wheel-slider-track-color: #dfe6e9; --wheel-slider-thumb-color: #3498db; --wheel-chart-bg-color: rgba(52, 152, 219, 0.2); --wheel-chart-border-color: #3498db; --wheel-goal-bg-color: rgba(231, 76, 60, 0.1); --wheel-goal-border-color: #e74c3c; --wheel-danger-color: #e74c3c; --wheel-danger-hover-color: #c0392b; --wheel-shadow-color: rgba(0, 0, 0, 0.1); --wheel-focus-ring-color: #74b9ff; --wheel-grid-color: #dbe4e9; --wheel-tooltip-bg: rgba(52, 73, 94, 0.95); --wheel-tooltip-text-color: white; --wheel-pillar-border-color: transparent; --wheel-pillar-border-width: 10px; --wheel-help-icon-color: #7f8c8d; --wheel-help-icon-hover-color: var(--wheel-primary-color); --wheel-action-key-color: #f39c12;

            --wheel-pillar-color-0: #e74c3c; --wheel-pillar-color-1: #e67e22; --wheel-pillar-color-2: #f1c40f; --wheel-pillar-color-3: #2ecc71; --wheel-pillar-color-4: #3498db; --wheel-pillar-color-5: #1abc9c; --wheel-pillar-color-6: #9b59b6; --wheel-pillar-color-7: #34495e;
        }
        #app-wheel.dark-theme {
            --wheel-bg-color: #2c3e50; --wheel-container-bg: #34495e; --wheel-text-color: #ecf0f1; --wheel-secondary-text-color: #bdc3c7; --wheel-primary-color: #3498db; --wheel-primary-hover-color: #5dade2; --wheel-disabled-color: #7f8c8d; --wheel-slider-track-color: #7f8c8d; --wheel-slider-thumb-color: #3498db; --wheel-chart-bg-color: rgba(52, 152, 219, 0.3); --wheel-chart-border-color: #5dade2; --wheel-goal-bg-color: rgba(241, 150, 138, 0.2); --wheel-goal-border-color: #f1948a; --wheel-danger-color: #e74c3c; --wheel-danger-hover-color: #f1948a; --wheel-shadow-color: rgba(0, 0, 0, 0.3); --wheel-focus-ring-color: #a9cce3; --wheel-grid-color: #566573; --wheel-tooltip-bg: rgba(236, 240, 241, 0.95); --wheel-tooltip-text-color: #2c3e50; --wheel-help-icon-color: #95a5a6; --wheel-help-icon-hover-color: var(--wheel-primary-color); --wheel-action-key-color: #f1c40f;

            --wheel-pillar-color-0: #c0392b; --wheel-pillar-color-1: #d35400; --wheel-pillar-color-2: #f39c12; --wheel-pillar-color-3: #27ae60; --wheel-pillar-color-4: #2980b9; --wheel-pillar-color-5: #16a085; --wheel-pillar-color-6: #8e44ad; --wheel-pillar-color-7: #7f8c8d;
        }
        /* Appliquer les couleurs de base de la roue au conteneur */
        #app-wheel {
             background-color: var(--wheel-bg-color);
             color: var(--wheel-text-color);
             font-family: 'Arial', sans-serif; /* Tailwind peut surcharger ça */
             touch-action: manipulation;
        }

        /* --- Layout & Containers --- */
        #app-wheel .wheel-main-view { max-width: 700px; margin: 20px auto; background: var(--wheel-container-bg); color: var(--wheel-text-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--wheel-shadow-color); transition: background-color 0.3s, color 0.3s, border-left-color 0.3s; }
        #app-wheel #wheel-inputView { border-left: var(--wheel-pillar-border-width) solid var(--wheel-pillar-border-color); padding-left: calc(30px - var(--wheel-pillar-border-width)); }
        #app-wheel #wheel-chartView { display: none; text-align: center; }

        /* --- Typography & Headings --- */
        #app-wheel h1, #app-wheel h2, #app-wheel h3 { text-align: center; color: var(--wheel-text-color); }
        #app-wheel h1 { font-size: 2.2rem; font-weight: 700; margin: 20px 0; }
        #app-wheel h2 { font-size: 1.8rem; margin-bottom: 20px;}
        #app-wheel h3 { font-size: 1.5rem; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;}
        #app-wheel h4 { margin-top: 15px; margin-bottom: 5px; color: var(--wheel-secondary-text-color); font-size: 1.1rem;}
        #app-wheel h5 { margin-top: 10px; margin-bottom: 5px; color: var(--wheel-secondary-text-color); font-size: 1rem;}

        /* --- Logo & Scores --- */
        #app-wheel .wheel-logo { display: block; margin: 0 auto 20px; max-width: 250px; height: auto; cursor: pointer; }
        #app-wheel #wheel-globalScore { font-size: 1.6rem; font-weight: 600; margin-bottom: 10px; text-align: center; }
        #app-wheel #wheel-pillarAverageScore { font-size: 1.1rem; font-weight: 500; margin-bottom: 20px; text-align: center; color: var(--wheel-secondary-text-color); }

        /* --- Pillar & Sub-Pillar Structure --- */
        #app-wheel .wheel-pillar-actions { display: flex; justify-content: center; gap: 10px; margin: 10px 0 20px; flex-wrap: wrap; }
        #app-wheel .wheel-pillar-actions button { padding: 6px 12px; font-size: 0.9rem; background-color: var(--wheel-slider-track-color); color: var(--wheel-text-color); }
        #app-wheel .wheel-pillar-actions button:hover:not(:disabled) { background-color: var(--wheel-primary-hover-color); color: white; }
        #app-wheel .wheel-pillar { margin-bottom: 25px; }
        #app-wheel .wheel-sub-pillar { margin: 20px 0; padding: 15px; border: 1px solid var(--wheel-slider-track-color); border-radius: 8px; background-color: var(--wheel-bg-color); transition: background-color 0.3s; }
        #app-wheel .wheel-sub-pillar-header { display: flex; align-items: center; justify-content: space-between; gap: 15px; margin-bottom: 10px; flex-wrap: wrap; }
        #app-wheel .wheel-sub-pillar label { flex-grow: 1; font-size: 1.1rem; color: var(--wheel-secondary-text-color); display: flex; align-items: center; gap: 8px; min-width: 150px; }
        #app-wheel .wheel-sub-pillar-controls { display: flex; align-items: center; gap: 10px; width: 60%; flex-grow: 1; min-width: 250px;}

        /* --- Sliders & Inputs --- */
        #app-wheel input[type="range"] { flex-grow: 1; margin-left: 10px; -webkit-appearance: none; appearance: none; height: 10px; background: var(--wheel-slider-track-color); border-radius: 5px; outline: none; transition: background 0.3s; cursor: pointer; box-shadow: inset 0 1px 3px var(--wheel-shadow-color); }
        #app-wheel input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: var(--wheel-slider-thumb-color); border-radius: 50%; cursor: pointer; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px var(--wheel-shadow-color); }
        #app-wheel input[type="range"]::-moz-range-thumb { width: 24px; height: 24px; background: var(--wheel-slider-thumb-color); border-radius: 50%; cursor: pointer; border: none; transition: background 0.3s, transform 0.2s; box-shadow: 0 2px 4px var(--wheel-shadow-color); }
        #app-wheel input[type="range"]::-webkit-slider-thumb:hover, #app-wheel input[type="range"]::-moz-range-thumb:hover { transform: scale(1.1); }
        #app-wheel input[type="range"]:focus { outline: 2px solid var(--wheel-focus-ring-color); outline-offset: 4px; } /* More visible focus */
        #app-wheel .wheel-slider-value { font-size: 1.1rem; font-weight: bold; min-width: 25px; text-align: right; }
        #app-wheel .wheel-sub-pillar-details { margin-top: 10px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        #app-wheel .wheel-detail-group { display: flex; align-items: center; gap: 5px; }
        #app-wheel .wheel-detail-group label { font-size: 0.9rem; color: var(--wheel-secondary-text-color); flex-grow: 0; }
        #app-wheel .wheel-detail-group input[type="number"] { padding: 5px 8px; border-radius: 4px; border: 1px solid var(--wheel-slider-track-color); background-color: var(--wheel-container-bg); color: var(--wheel-text-color); font-size: 0.9rem; width: 50px; text-align: center; }
        #app-wheel .wheel-note-button { background: none; border: none; padding: 3px; margin-left: 5px; cursor: pointer; color: var(--wheel-secondary-text-color); line-height: 0; }
        #app-wheel .wheel-note-button:hover { color: var(--wheel-primary-color); }
        #app-wheel .wheel-note-button svg { width: 18px; height: 18px; vertical-align: middle; }

        /* --- Buttons --- */
        #app-wheel .wheel-nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; gap: 15px; }
        #app-wheel button, #app-wheel .wheel-button-like { background-color: var(--wheel-primary-color); color: white; padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; text-align: center; transition: background-color 0.3s, transform 0.1s; text-decoration: none; display: inline-block; }
        #app-wheel button:disabled { background-color: var(--wheel-disabled-color); cursor: not-allowed; transform: none; }
        #app-wheel button:hover:not(:disabled), #app-wheel .wheel-button-like:hover { background-color: var(--wheel-primary-hover-color); transform: translateY(-2px); }
        #app-wheel button:active:not(:disabled), #app-wheel .wheel-button-like:active { transform: translateY(0); }
        #app-wheel button:focus-visible, #app-wheel .wheel-button-like:focus-visible { outline: 3px solid var(--wheel-focus-ring-color); outline-offset: 2px; }
        #app-wheel .wheel-danger-button { background-color: var(--wheel-danger-color); }
        #app-wheel .wheel-danger-button:hover:not(:disabled) { background-color: var(--wheel-danger-hover-color); }
        #app-wheel .wheel-icon-button { background: none; border: none; padding: 2px; cursor: pointer; color: var(--wheel-secondary-text-color); }
        #app-wheel .wheel-icon-button:hover { color: var(--wheel-primary-color); }
        #app-wheel .wheel-icon-button svg { width: 16px; height: 16px; vertical-align: middle; }
        #app-wheel .wheel-danger-button.wheel-icon-button:hover { color: var(--wheel-danger-color); }

        /* --- Chart --- */
        #app-wheel #wheel-radarChart { max-width: 100%; margin-top: 10px; background-color: var(--wheel-container-bg); border-radius: 8px; display: block; }

        /* --- Modals (Popups) --- */
        #app-wheel #wheel-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        #app-wheel #wheel-overlay:not([style*="display: flex"]) { display: none; }
        #app-wheel .wheel-popup { position: relative; background: var(--wheel-container-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px var(--wheel-shadow-color); max-width: 90%; max-height: 85vh; overflow-y: auto; width: 600px; z-index: 1000; flex-shrink: 0; display: none; }
        #app-wheel .wheel-popup h3, #app-wheel .wheel-popup h4 { margin-top: 0; text-align: center; padding-right: 35px; min-height: 1.5em; margin-right: 5px; }
        #app-wheel .wheel-popup-buttons { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap; }
        #app-wheel .wheel-popup-close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.8rem; line-height: 1; padding: 0 5px; color: var(--wheel-secondary-text-color); cursor: pointer; transition: color 0.2s; z-index: 1001; }
        #app-wheel .wheel-popup-close-btn:hover { color: var(--wheel-danger-color); }

        /* --- Note Popup Specific --- */
        #app-wheel #wheel-notePopup textarea { width: 100%; min-height: 150px; margin-top: 15px; padding: 10px; border: 1px solid var(--wheel-slider-track-color); border-radius: 4px; background-color: var(--wheel-bg-color); color: var(--wheel-text-color); font-size: 1rem; resize: vertical; box-sizing: border-box; }
        #app-wheel #wheel-notePopup #wheel-notePopupSubPillarName { font-weight: bold; color: var(--wheel-primary-color); }
        #app-wheel .wheel-action-key-checkbox { margin-top: 10px; display: flex; align-items: center; gap: 8px; }
        #app-wheel .wheel-action-key-checkbox label { font-size: 0.9rem; color: var(--wheel-secondary-text-color); }
        #app-wheel .wheel-action-key-checkbox input[type="checkbox"] { width: 16px; height: 16px; accent-color: var(--wheel-action-key-color); }

        /* --- History & Action Key Popups --- */
        #app-wheel #wheel-historyContent, #app-wheel #wheel-actionKeysContent { margin-top: 15px; }
        #app-wheel #wheel-historyContent ul, #app-wheel #wheel-actionKeysContent ul { list-style: none; padding: 0; }
        #app-wheel #wheel-historyContent li, #app-wheel #wheel-actionKeysContent li { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--wheel-slider-track-color); }
        #app-wheel #wheel-historyContent li:last-child, #app-wheel #wheel-actionKeysContent li:last-child { border-bottom: none; }
        #app-wheel .wheel-history-entry strong, #app-wheel .wheel-action-key-entry strong { font-size: 1.1em; }
        #app-wheel .wheel-history-scores, #app-wheel .wheel-action-key-note { margin-top: 5px; font-size: 0.9em; color: var(--wheel-secondary-text-color); }
        #app-wheel .wheel-action-key-note { white-space: pre-wrap; } /* Preserve line breaks in notes */
        #app-wheel .wheel-action-key-link { font-size: 0.8em; color: var(--wheel-primary-color); text-decoration: none; }
        #app-wheel .wheel-action-key-link:hover { text-decoration: underline; }
        #app-wheel .wheel-score-diff { margin-left: 5px; font-size: 0.8em; }
        #app-wheel .wheel-score-diff.positive { color: #2ecc71; font-weight: bold;}
        #app-wheel .wheel-score-diff.negative { color: var(--wheel-danger-color); font-weight: bold; }
        #app-wheel .wheel-history-scroll-container { margin-bottom: 10px; }
        #app-wheel #wheel-historyScrollToBottomBtn svg { width: 24px; height: 24px; vertical-align: middle; }
        #app-wheel #wheel-historyScrollToBottomBtn:hover { color: var(--wheel-primary-hover-color); background-color: var(--wheel-slider-track-color); border-radius: 50%; padding: 4px; }
        #app-wheel #wheel-historyPopup .wheel-popup-buttons { flex-wrap: wrap; overflow-x: auto; padding-bottom: 10px; justify-content: center; /* Avoid scrollbar overlap */}
        #app-wheel #wheel-compareControls { margin-top: 15px; }
        /* Mini Trend Graph */
        #app-wheel .wheel-mini-trend-graph { margin-bottom: 20px; padding: 15px; border: 1px solid var(--wheel-slider-track-color); border-radius: 8px; background-color: var(--wheel-bg-color); }
        #app-wheel .wheel-mini-trend-graph h5 { margin-top: 0; text-align: center; color: var(--wheel-secondary-text-color);}
        #app-wheel .wheel-trend-bars { display: flex; justify-content: space-around; align-items: flex-end; height: 60px; padding: 0 10px; }
        #app-wheel .wheel-trend-bar-item { display: flex; flex-direction: column; align-items: center; flex-basis: 0; flex-grow: 1; max-width: 50px; }
        #app-wheel .wheel-trend-bar { width: 70%; background-color: var(--wheel-primary-color); border-radius: 3px 3px 0 0; transition: height 0.3s ease-out; position: relative; }
        #app-wheel .wheel-trend-bar span { position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: var(--wheel-secondary-text-color); white-space: nowrap; }
        #app-wheel .wheel-trend-bar-item .wheel-bar-value { font-size: 0.8rem; margin-top: 3px; font-weight: bold; }

        /* --- Customization Popup --- */
        #app-wheel .wheel-customization-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--wheel-slider-track-color); }
        #app-wheel .wheel-customization-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        #app-wheel .wheel-customization-item input[type="text"] { flex-grow: 1; padding: 8px; border: 1px solid var(--wheel-slider-track-color); border-radius: 4px; background-color: var(--wheel-bg-color); color: var(--wheel-text-color); min-width: 150px; }

        /* --- Pillar Navigation --- */
        #app-wheel .wheel-pillar-nav { display: flex; justify-content: center; gap: 5px; /* Reduced gap */ flex-wrap: wrap; margin: 15px 0; }
        #app-wheel .wheel-pillar-nav-button { background-color: var(--wheel-slider-track-color); color: var(--wheel-text-color); padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 0.85rem; /* Slightly smaller */ border: none; }
        #app-wheel .wheel-pillar-nav-button.active { background-color: var(--wheel-primary-color); color: white; font-weight: bold; }
        #app-wheel .wheel-pillar-nav-button:hover:not(.active) { background-color: var(--wheel-primary-hover-color); color: white; }

        /* --- Theme Switch --- */
        #app-wheel .wheel-theme-switch-wrapper { display: flex; align-items: center; gap: 10px; position: absolute; top: 15px; right: 15px; z-index: 5; }
        #app-wheel .wheel-theme-switch { display: inline-block; height: 24px; position: relative; width: 50px; }
        #app-wheel .wheel-theme-switch input { display:none; }
        #app-wheel .wheel-slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; }
        #app-wheel .wheel-slider:before { background-color: #fff; bottom: 4px; content: ""; height: 16px; left: 4px; position: absolute; transition: .4s; width: 16px; border-radius: 50%; }
        #app-wheel input:checked + .wheel-slider { background-color: var(--wheel-primary-color); }
        #app-wheel input:checked + .wheel-slider:before { transform: translateX(26px); }

        /* --- Help Popup --- */
        #app-wheel #wheel-helpPopup ul { margin-top: 15px; padding-left: 20px; }
        #app-wheel #wheel-helpPopup li { margin-bottom: 8px; }

        /* --- Tooltips & Help Icons --- */
        #app-wheel .wheel-help-icon { display: inline-block; margin-left: 5px; color: var(--wheel-help-icon-color); cursor: help; position: relative; font-weight: bold; font-size: 0.9em; border: 1px solid var(--wheel-help-icon-color); border-radius: 50%; width: 16px; height: 16px; line-height: 16px; text-align: center; transition: color 0.2s, border-color 0.2s; }
        #app-wheel .wheel-help-icon:hover, #app-wheel .wheel-help-icon:focus { color: var(--wheel-help-icon-hover-color); border-color: var(--wheel-help-icon-hover-color); outline: none; }
        #app-wheel .wheel-tooltiptext { visibility: hidden; width: 220px; background-color: var(--wheel-tooltip-bg); color: var(--wheel-tooltip-text-color); text-align: left; font-size: 0.85rem; font-weight: normal; border-radius: 6px; padding: 8px 10px; position: absolute; z-index: 10; bottom: 135%; /* Position above the icon */ left: 50%; margin-left: -110px; /* Center the tooltip */ opacity: 0; transition: opacity 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #app-wheel .wheel-tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: var(--wheel-tooltip-bg) transparent transparent transparent; }
        #app-wheel .wheel-help-icon:hover .wheel-tooltiptext, #app-wheel .wheel-help-icon:focus .wheel-tooltiptext { visibility: visible; opacity: 1; }
        /* Ensure help icon is clickable */
        #app-wheel h3 .wheel-help-icon { line-height: 16px; }
        #app-wheel label .wheel-help-icon { line-height: 16px; vertical-align: middle; }

        /* --- Utility Classes (Wheel specific if needed, Tailwind handles most) --- */
        #app-wheel .wheel-hidden { display: none; }
        #app-wheel .wheel-text-center { text-align: center; }
        #app-wheel .wheel-mt-1 { margin-top: 10px; }
        #app-wheel .wheel-mt-2 { margin-top: 20px; }
        #app-wheel .wheel-mb-2 { margin-bottom: 20px; }
        #app-wheel .wheel-w-100 { width: 100%; }

        /* --- Loading & Notifications --- */
        #app-wheel .wheel-loading-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--wheel-container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px var(--wheel-shadow-color); z-index: 1000; }
        #app-wheel .wheel-notification { position: fixed; bottom: 20px; /* Changed to bottom */ left: 50%; transform: translateX(-50%); background: var(--wheel-primary-color); color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000; display: none; box-shadow: 0 2px 8px var(--wheel-shadow-color); }

        /* --- Media Queries (Wheel specific) --- */
        @media (max-width: 768px) {
             #app-wheel { padding: 10px; } /* Adjust padding for the container */
            #app-wheel .wheel-main-view { padding: 15px; }
            #app-wheel #wheel-inputView { padding-left: calc(15px - var(--wheel-pillar-border-width)); }
            #app-wheel h1 { font-size: 1.8rem; }
            #app-wheel .wheel-sub-pillar-header { flex-direction: column; align-items: stretch; gap: 8px; }
            #app-wheel .wheel-sub-pillar-controls { width: 100%; margin-top: 5px;}
            #app-wheel input[type="range"] { margin-left: 0; width: 100%; }
            #app-wheel .wheel-sub-pillar label { font-size: 1rem; }
            #app-wheel .wheel-popup-buttons { flex-direction: column; gap: 10px; }
            #app-wheel button, #app-wheel .wheel-button-like { width: 100%; }
            #app-wheel #wheel-historyPopup .wheel-popup-buttons { flex-direction: row; justify-content: center; flex-wrap: wrap; }
            #app-wheel #wheel-historyPopup .wheel-popup-buttons button, #app-wheel #wheel-historyPopup .wheel-popup-buttons .wheel-button-like { width: auto; flex-grow: 0; flex-shrink: 0; margin-bottom: 5px; }
            #app-wheel .wheel-popup { width: 95%; padding: 20px; max-height: 90vh; } /* Slightly wider popup on mobile */
            #app-wheel .wheel-theme-switch-wrapper { position: static; justify-content: center; margin: 15px 0 5px; order: -1; }
            #app-wheel .wheel-detail-group { flex-basis: calc(50% - 8px); }
            #app-wheel .wheel-detail-group:has(.wheel-note-button) { flex-basis: auto; }
            #app-wheel h3 { font-size: 1.3rem; }
            #app-wheel #wheel-notePopup textarea { min-height: 100px; }
            #app-wheel .wheel-popup-close-btn { font-size: 1.6rem; top: 8px; right: 10px; }
            #app-wheel .wheel-popup h3, #app-wheel .wheel-popup h4 { padding-right: 30px; }
            #app-wheel .wheel-pillar-nav { gap: 5px; }
            #app-wheel .wheel-pillar-nav-button { padding: 4px 8px; font-size: 0.8rem; }
            #app-wheel .wheel-pillar-actions { margin-bottom: 15px; }
            #app-wheel .wheel-tooltiptext { width: 180px; margin-left: -90px; bottom: 140%; } /* Adjust tooltip on smaller screens */
        }
        @media (max-width: 480px) {
            #app-wheel .wheel-detail-group { flex-basis: 100%; }
            #app-wheel h1 { font-size: 1.6rem; }
            #app-wheel h3 { flex-direction: column; gap: 5px; }
             #app-wheel .wheel-pillar-nav-button { flex-basis: calc(33% - 4px); text-align: center; } /* Stack nav buttons better */
             #app-wheel .wheel-pillar-actions button { font-size: 0.85rem; padding: 5px 10px; }
             #app-wheel .wheel-trend-bar span { font-size: 0.7rem; }
        }
        /* Dark theme preference (Wheel specific) */
        @media (prefers-color-scheme: dark) {
            body:not(.light-theme) #app-wheel { /* Apply only if body doesn't have light-theme AND we are inside #app-wheel */
                --wheel-bg-color: #2c3e50; --wheel-container-bg: #34495e; --wheel-text-color: #ecf0f1; --wheel-secondary-text-color: #bdc3c7; --wheel-primary-color: #3498db; --wheel-primary-hover-color: #5dade2; --wheel-disabled-color: #7f8c8d; --wheel-slider-track-color: #7f8c8d; --wheel-slider-thumb-color: #3498db; --wheel-chart-bg-color: rgba(52, 152, 219, 0.3); --wheel-chart-border-color: #5dade2; --wheel-goal-bg-color: rgba(241, 150, 138, 0.2); --wheel-goal-border-color: #f1948a; --wheel-danger-color: #e74c3c; --wheel-danger-hover-color: #f1948a; --wheel-shadow-color: rgba(0, 0, 0, 0.3); --wheel-focus-ring-color: #a9cce3; --wheel-grid-color: #566573; --wheel-tooltip-bg: rgba(236, 240, 241, 0.95); --wheel-tooltip-text-color: #2c3e50; --wheel-help-icon-color: #95a5a6; --wheel-help-icon-hover-color: var(--wheel-primary-color); --wheel-action-key-color: #f1c40f;

                --wheel-pillar-color-0: #c0392b; --wheel-pillar-color-1: #d35400; --wheel-pillar-color-2: #f39c12; --wheel-pillar-color-3: #27ae60; --wheel-pillar-color-4: #2980b9; --wheel-pillar-color-5: #16a085; --wheel-pillar-color-6: #8e44ad; --wheel-pillar-color-7: #7f8c8d;
            }
        }

        /* --- Styles préfixés pour App 2: Objectifs --- */
        #app-goals {
            --goals-font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --goals-color-text: #333;
            --goals-color-bg: #f4f7f6;
            --goals-color-primary: #007bff; /* Bleu par défaut */
            --goals-color-light-gray: #e9ecef;
            --goals-color-white: #fff;
            --goals-border-radius: 8px;
            --goals-box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Appliquer les couleurs de base des objectifs au conteneur */
        #app-goals {
            font-family: var(--goals-font-main); /* Tailwind peut surcharger */
            background-color: var(--goals-color-bg);
            color: var(--goals-color-text);
        }

        #app-goals .goals-container {
            width: 100%;
            max-width: 800px; /* Augmenté pour plus d'espace */
            margin: 1em auto;
            padding: 1em;
            box-sizing: border-box; /* Inclut padding dans la largeur */
        }

        /* --- Page d'accueil --- */
        #app-goals #goals-welcome-screen {
            text-align: center;
            background-color: var(--goals-color-white);
            padding: 3em 2em;
            border-radius: var(--goals-border-radius);
            box-shadow: var(--goals-box-shadow);
            margin-top: 5vh; /* Marge en haut */
        }

        #app-goals #goals-welcome-screen h1 {
            color: var(--goals-color-primary);
            margin-bottom: 0.5em;
        }

        #app-goals #goals-welcome-screen p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 1.5em;
            color: #555;
        }

        #app-goals #goals-start-button {
            background-color: var(--goals-color-primary);
            color: white;
            border: none;
            padding: 0.8em 1.5em;
            font-size: 1.1em;
            border-radius: var(--goals-border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #app-goals #goals-start-button:hover {
            background-color: #0056b3; /* Bleu plus foncé */
        }

        /* --- Contenu de l'application (caché initialement) --- */
        #app-goals #goals-app-content {
            display: none; /* Caché par défaut */
            background-color: var(--goals-color-white);
            border-radius: var(--goals-border-radius);
            box-shadow: var(--goals-box-shadow);
            padding: 2em;
            margin-top: 1em;
            transition: background-color 0.5s ease; /* Transition douce pour la couleur */
        }

        /* --- Header du Pilier Actuel --- */
        #app-goals #goals-pillar-header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1em;
            margin-bottom: 1.5em;
            border-radius: var(--goals-border-radius) var(--goals-border-radius) 0 0; /* Coins arrondis en haut */
            color: white;
            transition: background-color 0.5s ease;
        }

        #app-goals #goals-pillar-header i {
            font-size: 2em;
            margin-right: 0.5em;
        }

        #app-goals #goals-pillar-header h2 {
            margin: 0;
            font-size: 1.8em;
        }

        /* --- Contenu du Pilier --- */
        #app-goals #goals-pillar-content {
            margin-bottom: 2em;
        }

        #app-goals .goals-sous-pilier {
            margin-bottom: 1.5em;
            padding: 1em;
            background-color: #f8f9fa; /* Fond légèrement différent */
            border-left: 5px solid var(--goals-color-primary); /* Bordure colorée */
            border-radius: 4px;
            transition: border-left-color 0.5s ease;
        }

        #app-goals .goals-sous-pilier h3 {
            margin-top: 0;
            margin-bottom: 0.8em;
            color: var(--goals-color-primary);
            transition: color 0.5s ease;
            font-size: 1.3em;
        }

        #app-goals .goals-objectif {
            display: flex;
            align-items: center; /* Alignement vertical */
            margin-bottom: 0.5em;
            position: relative; /* Pour le tooltip */
        }

        #app-goals .goals-objectif-label {
            font-weight: bold;
            width: 100px; /* Largeur fixe pour les labels */
            margin-right: 10px;
            font-size: 0.9em;
            color: #666;
        }

        #app-goals .goals-objectif input {
            flex-grow: 1;
            padding: 0.6em;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: var(--goals-font-main);
            font-size: 1em;
            cursor: pointer; /* Indique qu'on peut cliquer */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
         #app-goals .goals-objectif input:hover {
            border-color: var(--goals-color-primary);
         }
         #app-goals .goals-objectif input:focus {
            outline: none;
            border-color: var(--goals-color-primary);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
         }

        /* --- Navigation --- */
        #app-goals #goals-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2em;
            padding-top: 1em;
            border-top: 1px solid var(--goals-color-light-gray);
        }

        #app-goals #goals-navigation button {
            background-color: var(--goals-color-primary);
            color: white;
            border: none;
            padding: 0.7em 1.2em;
            font-size: 1em;
            border-radius: var(--goals-border-radius);
            cursor: pointer;
            transition: background-color 0.3s ease, opacity 0.3s ease;
        }
        #app-goals #goals-navigation button:hover:not(:disabled) {
            filter: brightness(1.1); /* Éclaircit légèrement */
        }
        #app-goals #goals-navigation button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* --- Popup --- */
        #app-goals #goals-popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ccc;
            padding: 2em;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-radius: var(--goals-border-radius);
            width: 90%;
            max-width: 500px;
        }
        #app-goals #goals-popup textarea {
            width: calc(100% - 20px); /* Ajustement pour padding/border */
            padding: 10px;
            margin-bottom: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: var(--goals-font-main);
            font-size: 1em;
        }
        #app-goals #goals-popup button {
            background-color: var(--goals-color-primary);
            color: white;
            border: none;
            padding: 0.6em 1em;
            margin: 0.2em;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
         #app-goals #goals-popup button:hover {
            filter: brightness(1.1);
         }
        #app-goals #goals-popup button.danger {
            background-color: #dc3545; /* Rouge pour supprimer */
        }
        #app-goals #goals-popup button.secondary {
            background-color: #6c757d; /* Gris pour fermer */
        }

        /* --- Thèmes de couleurs pour les piliers --- */
        #app-goals[data-theme="sante"] { --goals-color-primary: #FF6347; /* Tomato */ }
        #app-goals[data-theme="famille"] { --goals-color-primary: #FFD700; /* Gold */ }
        #app-goals[data-theme="finances"] { --goals-color-primary: #32CD32; /* LimeGreen */ }
        #app-goals[data-theme="carriere"] { --goals-color-primary: #1E90FF; /* DodgerBlue */ }
        #app-goals[data-theme="loisirs"] { --goals-color-primary: #FF69B4; /* HotPink */ }
        #app-goals[data-theme="devperso"] { --goals-color-primary: #8A2BE2; /* BlueViolet */ }
        #app-goals[data-theme="relations"] { --goals-color-primary: #FF4500; /* OrangeRed */ }
        #app-goals[data-theme="cadrevie"] { --goals-color-primary: #00CED1; /* DarkTurquoise */ }

        /* Appliquer la couleur primaire dynamique */
        #app-goals #goals-pillar-header, #app-goals #goals-navigation button, #app-goals #goals-popup button, #app-goals #goals-start-button {
            background-color: var(--goals-color-primary);
        }
         #app-goals #goals-navigation button:hover:not(:disabled), #app-goals #goals-popup button:hover, #app-goals #goals-start-button:hover {
            filter: brightness(1.1);
         }
         #app-goals #goals-popup button.danger:hover { /* Garder le hover rouge spécifique */
             background-color: #c82333;
         }
         #app-goals #goals-popup button.secondary:hover { /* Garder le hover gris spécifique */
             background-color: #5a6268;
         }

        #app-goals .goals-sous-pilier {
            border-left-color: var(--goals-color-primary);
        }
        #app-goals .goals-sous-pilier h3 {
            color: var(--goals-color-primary);
        }
        #app-goals .goals-objectif input:hover, #app-goals .goals-objectif input:focus {
            border-color: var(--goals-color-primary);
        }
         #app-goals .goals-objectif input:focus {
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--goals-color-primary) 25%, transparent); /* Ombre avec la couleur dynamique */
         }

        /* Media query pour petits écrans (Goals specific) */
        @media (max-width: 600px) {
            #app-goals .goals-container {
                padding: 0.5em;
            }
            #app-goals #goals-welcome-screen {
                padding: 2em 1em;
                margin-top: 2vh;
            }
            #app-goals #goals-app-content {
                padding: 1em;
            }
            #app-goals #goals-pillar-header h2 {
                font-size: 1.5em;
            }
             #app-goals #goals-pillar-header i {
                font-size: 1.8em;
            }
            #app-goals .goals-sous-pilier h3 {
                font-size: 1.1em;
            }
            #app-goals .goals-objectif {
                flex-direction: column; /* Empile label et input */
                align-items: flex-start;
            }
            #app-goals .goals-objectif-label {
                width: auto; /* Prend la largeur nécessaire */
                margin-bottom: 5px;
            }
            #app-goals #goals-popup {
                width: 95%;
            }
            #app-goals #goals-navigation {
                flex-direction: column;
                gap: 10px; /* Espace entre les boutons empilés */
            }
            #app-goals #goals-navigation button {
                width: 100%;
            }
        }

        /* --- Styles préfixés pour App 3: Rituels --- */
        /* Note: Tailwind gère la plupart des styles. On ajoute juste les styles spécifiques. */
        #app-rituals {
            --rituals-primary: #6366f1;
            --rituals-primary-dark: #4f46e5;
            --rituals-secondary: #f59e0b;
            --rituals-success: #10b981;
            --rituals-danger: #ef4444;
            --rituals-light: #f8fafc;
            --rituals-dark: #1e293b;
        }

        #app-rituals .rituals-morning-bg {
            background: linear-gradient(135deg, #f9d423 0%, #f83600 100%);
        }

        #app-rituals .rituals-afternoon-bg {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        #app-rituals .rituals-evening-bg {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
        }

        #app-rituals .rituals-night-bg {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        }

        #app-rituals .rituals-ritual-card {
            transition: all 0.3s ease;
        }

        #app-rituals .rituals-ritual-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        #app-rituals .rituals-progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #e2e8f0; /* gray-200 */
        }

        #app-rituals .rituals-progress-fill {
            height: 100%;
            border-radius: 4px;
            background-color: var(--rituals-primary);
            transition: width 0.5s ease;
        }

        #app-rituals .rituals-chart-container {
            height: 300px;
        }

        @media (max-width: 640px) {
            #app-rituals .rituals-chart-container {
                height: 200px;
            }
        }

        /* Ajustement pour les modales de l'app 3 pour coexister */
        #app-rituals .rituals-modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1050; /* Au dessus de l'overlay de la roue */
        }
        #app-rituals .rituals-modal.hidden {
            display: none;
        }

    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Navigation Principale -->
    <nav class="main-nav">
        <button id="nav-wheel" onclick="MainApp.showApp('wheel')" class="active">Roue de la Vie</button>
        <button id="nav-goals" onclick="MainApp.showApp('goals')">Objectifs</button>
        <button id="nav-rituals" onclick="MainApp.showApp('rituals')">Rituels</button>
    </nav>

    <!-- Conteneur pour l'App 1: Roue de la Vie -->
    <div id="app-wheel" class="app-container active">
        <!-- Contenu HTML de l'App 1 (préfixé) -->
        <!-- Welcome View -->
        <div id="wheel-welcomeView" class="wheel-main-view" style="display: none;"> <!-- Sera affiché par JS au besoin -->
            <img src="logo.png" alt="La Roue de la Vie Interactive" class="wheel-logo" id="wheel-appLogo"> <!-- ID ajouté pour le long press -->
            <h2>Bienvenue sur la Roue de la Vie Interactive !</h2>
            <p style="text-align: center; font-size: 1.1em; color: var(--wheel-secondary-text-color); margin-bottom: 25px;">
                Prenez de la hauteur et redécouvrez votre équilibre global.
            </p>
            <p>Vous tenez entre les mains un outil puissant d'introspection et de visualisation. Son objectif est simple mais profond : vous aider à obtenir une image claire et honnête de l'équilibre actuel entre les différents domaines essentiels de votre existence.</p>
            <h4>Le Piège de la Focalisation Excessive</h4>
            <p>Vous sentez-vous parfois submergé(e) par <em>un</em> problème spécifique ? Une difficulté au travail, une tension relationnelle, une préoccupation financière... Il est naturel de focaliser notre attention, parfois de manière excessive, sur ce qui nous semble le plus urgent ou le plus douloureux.</p>
            <p>Le risque ? Cette "vision tunnel" peut nous faire perdre de vue la situation dans son ensemble, oublier nos forces et amplifier notre sentiment de déséquilibre.</p>
            <h4>La Solution : Défocaliser avec la Roue</h4>
            <p>C'est là que la Roue de la Vie devient un allié précieux. En vous invitant à évaluer, de manière égale, <em>tous</em> les piliers importants de votre vie, cet outil vous aide à <strong>défocaliser</strong> :</p>
            <ul>
                <li>Prendre du recul et voir la "carte complète".</li>
                <li>Élargir votre perspective au-delà du problème du moment.</li>
                <li>Identifier vos forces et les domaines satisfaisants.</li>
                <li>Relativiser les difficultés dans un contexte global.</li>
            </ul>
             <h4>Les Bienfaits</h4>
             <p>Utiliser cet outil vous permettra de gagner en clarté, mieux cibler vos efforts, réduire le sentiment d'être submergé(e), célébrer vos réussites et agir de manière plus alignée.</p>
            <p style="margin-top: 25px; font-style: italic; color: var(--wheel-secondary-text-color);">Vos données sont confidentielles et stockées uniquement dans votre navigateur.</p>
            <div class="wheel-text-center wheel-mt-2">
                <button onclick="WheelApp.startEvaluation()" class="wheel-button-like" style="padding: 15px 30px; font-size: 1.1em;">Commencer mon évaluation</button>
            </div>
        </div>

        <!-- Theme Switch -->
        <div class="wheel-theme-switch-wrapper">
            <span aria-hidden="true">☀️</span>
            <label class="wheel-theme-switch" for="wheel-theme-checkbox">
                <input type="checkbox" id="wheel-theme-checkbox" aria-label="Changer de thème (clair/sombre)">
                <span class="wheel-slider round"></span>
            </label>
            <span aria-hidden="true">🌙</span>
        </div>

        <!-- Loading Message & Notifications -->
        <div id="wheel-loadingMessage" class="wheel-loading-message">Chargement...</div>
        <div id="wheel-notification" class="wheel-notification"></div>

        <!-- Input View -->
        <div id="wheel-inputView" class="wheel-main-view">
            <div id="wheel-pillarNavigation" class="wheel-pillar-nav" role="navigation" aria-label="Navigation entre les piliers"></div>
            <div id="wheel-globalScore" aria-live="polite">Note globale : - / 20</div>
            <div id="wheel-pillarDisplay">
                <!-- Pillar content will be rendered here by JS -->
            </div>
            <div id="wheel-pillarAverageScore" aria-live="polite">Moyenne Pilier : - / 10</div>
            <div class="wheel-nav-buttons">
                <button id="wheel-prevBtn" onclick="WheelApp.changePillar(-1)" aria-label="Aller au pilier précédent (Flèche Gauche)">Précédent</button>
                <button id="wheel-nextBtn" onclick="WheelApp.changePillar(1)" aria-label="Aller au pilier suivant (Flèche Droite)">Suivant</button>
            </div>
            <button id="wheel-showChartBtn" onclick="WheelApp.showChartAndSave()" class="wheel-w-100 wheel-mt-2" aria-label="Afficher le graphique et sauvegarder l'évaluation">Afficher la Roue & Sauvegarder</button>
            <div class="wheel-mt-2 wheel-text-center" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                <button id="wheel-personalizeBtn" onclick="WheelApp.openModal('wheel-customizationPopup')" aria-label="Ouvrir les options de personnalisation" style="display: none;">Personnaliser</button>
                <button onclick="WheelApp.openModal('wheel-helpPopup')" aria-label="Ouvrir l'aide">Aide</button>
            </div>
        </div>

        <!-- Chart View -->
        <div id="wheel-chartView" class="wheel-main-view">
            <h2>Votre Roue de la Vie</h2>
            <canvas id="wheel-radarChart" aria-label="Graphique radar des scores de la roue de la vie"></canvas>
            <div class="wheel-mt-2 wheel-mb-2" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                 <button onclick="WheelApp.openModal('wheel-historyPopup')" aria-label="Ouvrir l'historique des évaluations">Historique</button>
                 <button onclick="WheelApp.showInputView()" aria-label="Revenir à la saisie des notes">Retour au Menu</button>
            </div>
        </div>

        <!-- Overlay & Modals -->
        <div id="wheel-overlay" onclick="WheelApp.closeAllModals()">

            <!-- History Popup -->
            <div id="wheel-historyPopup" class="wheel-popup" role="dialog" aria-labelledby="wheel-historyTitle" aria-modal="true" onclick="event.stopPropagation()">
                <button onclick="WheelApp.closeModal('wheel-historyPopup')" class="wheel-popup-close-btn" aria-label="Fermer la fenêtre d'historique">×</button>
                <h3 id="wheel-historyTitle">Historique des évaluations</h3>
                <div class="wheel-history-scroll-container wheel-text-center">
                    <button id="wheel-historyScrollToBottomBtn" class="wheel-icon-button" onclick="WheelApp.historyScrollToBottom()" aria-label="Aller aux boutons en bas" title="Aller aux boutons en bas" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M11,4H13V16L18.5,10.5L19.92,11.92L12,19.84L4.08,11.92L5.5,10.5L11,16V4Z" /></svg>
                    </button>
                </div>
                 <div id="wheel-miniTrendGraphContainer">
                     <!-- Mini trend graph will be rendered here -->
                 </div>
                <div id="wheel-historyContent"></div>
                <div id="wheel-compareControls" class="wheel-mt-1 wheel-text-center" style="display: none;">
                    <button id="wheel-compareBtn" onclick="WheelApp.compareSelectedEntries()" disabled aria-label="Comparer les 2 évaluations sélectionnées">Comparer (2)</button>
                </div>
                <div class="wheel-popup-buttons">
                    <input type="file" id="wheel-importFile" accept=".json" style="display: none;" onchange="WheelApp.importData(event)">
                    <button id="wheel-importBtn" onclick="document.getElementById('wheel-importFile').click()" aria-label="Importer des données depuis un fichier JSON" style="display: none;">Importer</button>
                    <button onclick="WheelApp.exportData()" class="wheel-button-like" style="display: none;">Exporter Tout (JSON)</button>
                    <button onclick="WheelApp.openModal('wheel-actionKeysPopup')" aria-label="Voir les actions clés définies">Voir Actions Clés</button>
                    <button onclick="WheelApp.copyHistory()" aria-label="Copier l'historique et prompt pour analyse IA">Copier pour IA</button>
                    <button onclick="WheelApp.resetApp()" class="wheel-danger-button" aria-label="Réinitialiser toutes les données de l'application">Tout Réinitialiser</button>
                    <button onclick="WheelApp.closeModal('wheel-historyPopup')" aria-label="Fermer la fenêtre d'historique">Fermer</button>
                </div>
            </div>

            <!-- Customization Popup -->
            <div id="wheel-customizationPopup" class="wheel-popup" role="dialog" aria-labelledby="wheel-customizationTitle" aria-modal="true" onclick="event.stopPropagation()">
                <button onclick="WheelApp.closeModal('wheel-customizationPopup')" class="wheel-popup-close-btn" aria-label="Fermer la fenêtre de personnalisation">×</button>
                <h3 id="wheel-customizationTitle">Personnaliser les Piliers</h3>
                <div id="wheel-customizationContent"></div>
                <p style="font-size: 0.9em; color: var(--wheel-secondary-text-color);">Note : L'ajout de nouveaux piliers/sous-piliers n'est pas supporté...</p>
                <div class="wheel-popup-buttons">
                    <button onclick="WheelApp.saveCustomization()" aria-label="Sauvegarder les changements de personnalisation">Sauvegarder & Fermer</button>
                    <button onclick="WheelApp.closeModal('wheel-customizationPopup')" aria-label="Annuler et fermer la fenêtre de personnalisation">Annuler</button>
                </div>
            </div>

            <!-- Help Popup -->
            <div id="wheel-helpPopup" class="wheel-popup" role="dialog" aria-labelledby="wheel-helpTitle" aria-modal="true" onclick="event.stopPropagation()">
                <button onclick="WheelApp.closeModal('wheel-helpPopup')" class="wheel-popup-close-btn" aria-label="Fermer la fenêtre d'aide">×</button>
                <h3 id="wheel-helpTitle">Aide - La Roue de la Vie</h3>
                <p>La Roue de la Vie est un outil d'auto-évaluation qui vous aide à visualiser l'équilibre dans différents domaines de votre vie.</p>
                <ul>
                    <li>Naviguez entre les "Piliers" (domaines) avec "Précédent" / "Suivant", la barre de navigation rapide, ou les flèches ← → du clavier (hors champs texte).</li>
                    <li>Notez chaque "Sous-Pilier" de 1 (bas) à 10 (haut) avec le curseur (ajustable aussi avec les flèches du clavier une fois sélectionné).</li>
                    <li>Cliquez sur l'icône <span class="wheel-help-icon" style="cursor:default; border:none; font-size: 1em; line-height: 1em; width:auto; height:auto;">?</span> à côté des titres pour des indices sur le domaine couvert.</li>
                    <li>Cliquez sur l'icône <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:1em; height:1em; vertical-align: -0.125em;"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg> pour ajouter une note détaillée. Marquez une note comme "Action Clé" pour la retrouver facilement via l'historique.</li>
                    <li>Définissez un objectif optionnel (1-10) pour chaque sous-pilier (défaut: 10). Utilisez les boutons "Appliquer Objectif 10 à tous" ou "Réinitialiser Notes à 5" pour gagner du temps.</li>
                    <li>Cliquez sur "Afficher la Roue & Sauvegarder" pour voir le graphique et enregistrer l'évaluation (remplace l'entrée du jour si < 24h).</li>
                    <li>Depuis le graphique, utilisez "Retour au Menu" ou "Historique".</li>
                    <li>Dans "Historique", cochez deux entrées et cliquez sur "Comparer" pour un graphique comparatif. Voyez aussi un mini-graphique de tendance globale et accédez à vos "Actions Clés".</li>
                    <li><span id="wheel-helpPersonalizeSection" style="display: none;">"Personnaliser" (premium) permet de renommer ou supprimer des piliers/sous-piliers.<br></span></li>
                    <li><span id="wheel-helpImportSection" style="display: none;">"Importer" (premium, depuis l'historique) permet de charger des données JSON.<br></span></li>
                    <li>L'activation du mode Premium (appui long sur le logo) sera possible prochainement sous condition.</li>
                    <li>Utilisez l'interrupteur (☀️/🌙) pour changer de thème.</li>
                    <li>Exportez vos données via "Copier pour IA" (prompt inclus) ou "Exporter Tout (JSON)".</li>
                    <li>L'application fonctionne hors ligne grâce à la sauvegarde locale (LocalStorage).</li>
                </ul>
                <div class="wheel-popup-buttons">
                    <button onclick="WheelApp.closeModal('wheel-helpPopup')" aria-label="Fermer la fenêtre d'aide">Fermer</button>
                </div>
            </div>

            <!-- Note Popup -->
            <div id="wheel-notePopup" class="wheel-popup" role="dialog" aria-labelledby="wheel-notePopupTitle" aria-modal="true" onclick="event.stopPropagation()">
                <button onclick="WheelApp.closeModal('wheel-notePopup')" class="wheel-popup-close-btn" aria-label="Fermer la fenêtre de note">×</button>
                <h4 id="wheel-notePopupTitle">Ajouter/Modifier une Note pour <span id="wheel-notePopupSubPillarName"></span></h4>
                <textarea id="wheel-notePopupTextarea" placeholder="Écrivez vos réflexions, détails, contexte, prochaines étapes ici..." aria-label="Champ pour ajouter ou modifier une note"></textarea>
                <div class="wheel-action-key-checkbox">
                     <input type="checkbox" id="wheel-notePopupActionKey" aria-label="Marquer cette note comme une action clé">
                     <label for="wheel-notePopupActionKey">Marquer comme Action Clé</label>
                </div>
                <div class="wheel-popup-buttons">
                    <button id="wheel-saveNoteBtn" onclick="WheelApp.saveNoteFromPopup()" aria-label="Sauvegarder la note">Sauvegarder</button>
                    <button onclick="WheelApp.closeModal('wheel-notePopup')" aria-label="Annuler et fermer la fenêtre de note">Annuler</button>
                </div>
            </div>

            <!-- Action Keys Popup -->
            <div id="wheel-actionKeysPopup" class="wheel-popup" role="dialog" aria-labelledby="wheel-actionKeysTitle" aria-modal="true" onclick="event.stopPropagation()">
                <button onclick="WheelApp.closeModal('wheel-actionKeysPopup')" class="wheel-popup-close-btn" aria-label="Fermer la fenêtre des actions clés">×</button>
                <h3 id="wheel-actionKeysTitle">Vos Actions Clés</h3>
                <div id="wheel-actionKeysContent">
                    <!-- Action keys will be rendered here -->
                </div>
                 <p style="font-size: 0.85em; color: var(--wheel-secondary-text-color); margin-top:15px;">Ce sont les notes que vous avez marquées comme "Action Clé".</p>
                <div class="wheel-popup-buttons">
                    <button onclick="WheelApp.closeModal('wheel-actionKeysPopup')" aria-label="Fermer la fenêtre des actions clés">Fermer</button>
                </div>
            </div>

        </div>
        <!-- Fin Contenu HTML App 1 -->
    </div>

    <!-- Conteneur pour l'App 2: Objectifs -->
    <div id="app-goals" class="app-container">
        <!-- Contenu HTML de l'App 2 (préfixé) -->
        <div class="goals-container">

            <!-- Écran d'accueil -->
            <div id="goals-welcome-screen">
                <h1><i class="fas fa-route"></i> Bienvenue sur Mon Parcours d'Objectifs !</h1>
                <p>
                    Cette application a été conçue pour vous accompagner dans la définition, le suivi et l'atteinte de vos objectifs personnels, quels que soient les domaines qui comptent pour vous : santé, famille, finances, carrière, loisirs, développement personnel, relations sociales ou cadre de vie.
                </p>
                <p>
                    Que vous souhaitiez améliorer votre bien-être, renforcer vos liens avec vos proches, optimiser vos ressources financières ou réaliser vos ambitions professionnelles, "Mon Parcours d'Objectifs" vous offre un cadre structuré pour transformer vos intentions en actions concrètes. Prenez quelques instants pour réfléchir à ce que vous désirez accomplir et commencez dès aujourd'hui à façonner la vie qui vous ressemble.
                </p>
                <button id="goals-start-button">Commencer mon parcours <i class="fas fa-arrow-right"></i></button>
            </div>

            <!-- Contenu principal de l'application -->
            <div id="goals-app-content">
                <header id="goals-pillar-header">
                    <i id="goals-pillar-icon" class="fas fa-question-circle"></i> <!-- Icône par défaut -->
                    <h2 id="goals-pillar-title">Titre du Pilier</h2>
                </header>

                <main id="goals-pillar-content">
                    <!-- Le contenu du pilier actif sera injecté ici par JS -->
                </main>

                <nav id="goals-navigation">
                    <button id="goals-prev-button"><i class="fas fa-arrow-left"></i> Précédent</button>
                    <button id="goals-next-button">Suivant <i class="fas fa-arrow-right"></i></button>
                </nav>
            </div>

        </div>

        <!-- Popup pour modifier/supprimer -->
        <div id="goals-popup">
            <h4>Modifier l'objectif</h4>
            <textarea id="goals-popup-text" rows="5" cols="50"></textarea><br>
            <button onclick="GoalsApp.modifierObjectif()">💾 Enregistrer</button>
            <button class="danger" onclick="GoalsApp.supprimerObjectif()">🗑️ Supprimer</button>
            <button class="secondary" onclick="GoalsApp.fermerPopup()">❌ Fermer</button>
        </div>
        <!-- Fin Contenu HTML App 2 -->
    </div>

    <!-- Conteneur pour l'App 3: Rituels -->
    <div id="app-rituals" class="app-container">
        <!-- Contenu HTML de l'App 3 (préfixé) -->
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Header -->
            <header class="mb-8 text-center">
                <h1 class="text-4xl font-bold text-indigo-600 mb-2">Rituels Quotidiens</h1>
                <p class="text-lg text-gray-600">Transformez votre routine en habitudes puissantes</p>
                <div class="mt-4 flex justify-center space-x-2">
                    <span id="rituals-current-date" class="text-gray-700 font-medium"></span>
                    <span id="rituals-streak-count" class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium"></span>
                </div>
            </header>

            <!-- Main Content -->
            <main>
                <!-- Tabs Navigation (Interne à l'app Rituels) -->
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="rituals-today-tab" class="px-4 py-2 font-medium text-indigo-600 border-b-2 border-indigo-600">Aujourd'hui</button>
                    <button id="rituals-history-tab" class="px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Historique</button>
                    <button id="rituals-stats-tab" class="px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Statistiques</button>
                    <button id="rituals-settings-tab" class="px-4 py-2 font-medium text-gray-500 hover:text-indigo-600">Paramètres</button>
                </div>

                <!-- Today Tab Content -->
                <div id="rituals-today-content" class="rituals-tab-content">
                    <!-- Progress Summary -->
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Votre progression aujourd'hui</h2>
                        <div class="flex items-center mb-2">
                            <div class="w-full mr-4">
                                <div class="rituals-progress-bar">
                                    <div id="rituals-daily-progress" class="rituals-progress-fill" style="width: 0%"></div>
                                </div>
                            </div>
                            <span id="rituals-progress-percentage" class="text-lg font-bold text-indigo-600">0%</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span id="rituals-completed-count">0 complétés</span>
                            <span id="rituals-total-count">0 total</span>
                        </div>
                    </div>

                    <!-- Time of Day Sections -->
                    <div class="mb-8">
                        <div class="rituals-morning-bg rounded-lg shadow overflow-hidden mb-6">
                            <div class="px-6 py-4 bg-white bg-opacity-90">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-semibold text-orange-700">Matin</h3>
                                    <span id="rituals-morning-progress" class="text-sm font-medium text-orange-700">0/0</span>
                                </div>
                                <div id="rituals-morning-rituals" class="mt-4 space-y-3"></div>
                            </div>
                        </div>

                        <div class="rituals-afternoon-bg rounded-lg shadow overflow-hidden mb-6">
                            <div class="px-6 py-4 bg-white bg-opacity-90">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-semibold text-blue-700">Après-midi</h3>
                                    <span id="rituals-afternoon-progress" class="text-sm font-medium text-blue-700">0/0</span>
                                </div>
                                <div id="rituals-afternoon-rituals" class="mt-4 space-y-3"></div>
                            </div>
                        </div>

                        <div class="rituals-evening-bg rounded-lg shadow overflow-hidden">
                            <div class="px-6 py-4 bg-white bg-opacity-90">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-xl font-semibold text-purple-700">Soir</h3>
                                    <span id="rituals-evening-progress" class="text-sm font-medium text-purple-700">0/0</span>
                                </div>
                                <div id="rituals-evening-rituals" class="mt-4 space-y-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Reflection -->
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Réflexion du jour</h2>
                        <textarea id="rituals-daily-reflection" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="Notez vos pensées, réalisations ou intentions pour aujourd'hui..."></textarea>
                        <button id="rituals-save-reflection" class="mt-3 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Enregistrer</button>
                    </div>
                </div>

                <!-- History Tab Content -->
                <div id="rituals-history-content" class="rituals-tab-content hidden">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Votre historique</h2>
                        <div class="flex justify-between items-center mb-4">
                            <div class="relative">
                                <select id="rituals-history-filter" class="appearance-none bg-white border border-gray-300 rounded-lg px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="all">Tous les rituels</option>
                                    <option value="completed">Complétés</option>
                                    <option value="missed">Manqués</option>
                                </select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                            <button id="rituals-export-history" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center">
                                <i class="fas fa-file-export mr-2"></i> Exporter
                            </button>
                        </div>
                        <div id="rituals-history-list" class="space-y-4"></div>
                    </div>
                </div>

                <!-- Stats Tab Content -->
                <div id="rituals-stats-content" class="rituals-tab-content hidden">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6">Vos statistiques</h2>

                        <!-- Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div class="bg-indigo-50 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-indigo-100 mr-4">
                                        <i class="fas fa-fire text-indigo-600"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Séquence actuelle</p>
                                        <p id="rituals-current-streak" class="text-2xl font-bold text-indigo-600">0 jours</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-green-100 mr-4">
                                        <i class="fas fa-check-circle text-green-600"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Taux de réussite</p>
                                        <p id="rituals-success-rate" class="text-2xl font-bold text-green-600">0%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-yellow-100 mr-4">
                                        <i class="fas fa-star text-yellow-600"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-600">Rituel favori</p>
                                        <p id="rituals-favorite-ritual" class="text-2xl font-bold text-yellow-600">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Progression hebdomadaire</h3>
                                <div class="rituals-chart-container">
                                    <canvas id="rituals-weekly-chart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Répartition des rituels</h3>
                                <div class="rituals-chart-container">
                                    <canvas id="rituals-ritual-distribution-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab Content -->
                <div id="rituals-settings-content" class="rituals-tab-content hidden">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-6">Paramètres</h2>

                        <!-- Ritual Management -->
                        <div class="mb-8">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Gestion des rituels</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <h4 class="font-medium text-gray-800">Rituels disponibles</h4>
                                        <p class="text-sm text-gray-600">Activez ou désactivez les rituels que vous souhaitez suivre</p>
                                    </div>
                                    <button id="rituals-add-ritual-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                                        <i class="fas fa-plus mr-2"></i> Ajouter
                                    </button>
                                </div>

                                <div id="rituals-available-rituals" class="space-y-3"></div>
                            </div>
                        </div>

                        <!-- Time Preferences -->
                        <div class="mb-8">
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Préférences de temps</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="p-4 border border-gray-200 rounded-lg">
                                    <label for="rituals-morning-cutoff" class="block text-sm font-medium text-gray-700 mb-1">Fin du matin</label>
                                    <input type="time" id="rituals-morning-cutoff" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div class="p-4 border border-gray-200 rounded-lg">
                                    <label for="rituals-afternoon-cutoff" class="block text-sm font-medium text-gray-700 mb-1">Fin d'après-midi</label>
                                    <input type="time" id="rituals-afternoon-cutoff" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div class="p-4 border border-gray-200 rounded-lg">
                                    <label for="rituals-evening-cutoff" class="block text-sm font-medium text-gray-700 mb-1">Fin de soirée</label>
                                    <input type="time" id="rituals-evening-cutoff" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-4">Gestion des données</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button id="rituals-reset-data" class="flex items-center justify-center p-4 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 transition">
                                    <i class="fas fa-trash-alt text-red-600 mr-3"></i>
                                    <span class="font-medium text-red-600">Réinitialiser toutes les données</span>
                                </button>
                                <button id="rituals-import-data" class="flex items-center justify-center p-4 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition">
                                    <i class="fas fa-file-import text-blue-600 mr-3"></i>
                                    <span class="font-medium text-blue-600">Importer des données</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Add Ritual Modal -->
        <div id="rituals-add-ritual-modal" class="rituals-modal hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Ajouter un nouveau rituel</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="rituals-ritual-name" class="block text-sm font-medium text-gray-700 mb-1">Nom du rituel</label>
                            <input type="text" id="rituals-ritual-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: Méditation">
                        </div>
                        <div>
                            <label for="rituals-ritual-category" class="block text-sm font-medium text-gray-700 mb-1">Moment de la journée</label>
                            <select id="rituals-ritual-category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="morning">Matin</option>
                                <option value="afternoon">Après-midi</option>
                                <option value="evening">Soir</option>
                            </select>
                        </div>
                        <div>
                            <label for="rituals-ritual-icon" class="block text-sm font-medium text-gray-700 mb-1">Icône</label>
                            <select id="rituals-ritual-icon" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="sun">☀️ Soleil</option>
                                <option value="meditation">🧘 Méditation</option>
                                <option value="book">📚 Lecture</option>
                                <option value="exercise">💪 Exercice</option>
                                <option value="journal">📓 Journal</option>
                                <option value="water">💧 Eau</option>
                                <option value="coffee">☕ Café</option>
                                <option value="moon">🌙 Lune</option>
                                <option value="list">📝 Liste</option>
                                <option value="utensils">🍽️ Repas</option>
                                <option value="walking">🚶 Marche</option>
                                <option value="bullseye">🎯 Objectif</option>
                                <option value="mobile-screen">📱 Écran</option>
                                <option value="spa">🧖 Détente</option>
                                <option value="book-open">📖 Lecture</option>
                                <option value="heart">❤️ Gratitude</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="rituals-cancel-add-ritual" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Annuler</button>
                        <button id="rituals-confirm-add-ritual" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Ajouter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="rituals-export-modal" class="rituals-modal hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Exporter vos données</h3>
                    <div class="mb-4">
                        <p class="text-gray-600 mb-2">Voici l'export de votre historique au format JSON :</p>
                        <textarea id="rituals-export-data" class="w-full h-64 px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm" readonly></textarea>
                    </div>
                    <div class="mb-4">
                        <p class="text-gray-600 mb-2">Vous pouvez copier ces données ou les soumettre à une IA pour obtenir un coaching personnalisé :</p>
                        <textarea id="rituals-ai-prompt" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3">Voici mon historique de rituels quotidiens. Peux-tu analyser mes habitudes et me donner des conseils personnalisés pour améliorer ma routine ? Quels sont mes points forts et mes axes d'amélioration ?</textarea>
                    </div>
                    <div class="flex justify-between items-center">
                        <button id="rituals-copy-export" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center">
                            <i class="fas fa-copy mr-2"></i> Copier
                        </button>
                        <div class="flex space-x-3">
                            <button id="rituals-close-export" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Fermer</button>
                            <button id="rituals-submit-to-ai" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center">
                                <i class="fas fa-robot mr-2"></i> Soumettre à l'IA
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="rituals-confirmation-modal" class="rituals-modal hidden">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6">
                    <h3 id="rituals-confirmation-title" class="text-xl font-semibold text-gray-800 mb-4">Confirmation</h3>
                    <p id="rituals-confirmation-message" class="text-gray-600 mb-6">Êtes-vous sûr de vouloir effectuer cette action ?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="rituals-cancel-confirm" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Annuler</button>
                        <button id="rituals-confirm-action" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Confirmer</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fin Contenu HTML App 3 -->
    </div>


    <script>
        // ========================================================================
        // == MAIN APP LOGIC (Navigation & Initialization) ========================
        // ========================================================================
        const MainApp = {
            init: function() {
                console.log("MainApp Initializing...");
                this.setupNav();
                // Initialize each sub-app
                WheelApp.init();
                GoalsApp.init();
                RitualsApp.init();
                // Show the default app
                this.showApp('wheel');
                console.log("MainApp Initialized.");
            },

            setupNav: function() {
                const navButtons = document.querySelectorAll('.main-nav button');
                navButtons.forEach(button => {
                    // The onclick attribute handles the call to showApp
                    // We just need to handle the active state visually here
                    button.addEventListener('click', () => {
                        navButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    });
                });
            },

            showApp: function(appName) {
                console.log(`Switching to app: ${appName}`);
                const appContainers = document.querySelectorAll('.app-container');
                appContainers.forEach(container => {
                    container.classList.remove('active');
                    container.style.display = 'none'; // Ensure it's hidden
                });

                const targetContainer = document.getElementById(`app-${appName}`);
                if (targetContainer) {
                    targetContainer.classList.add('active');
                    targetContainer.style.display = 'block'; // Ensure it's visible

                    // Optional: Call a 'reactivate' or 'render' function for the specific app if needed
                    if (appName === 'wheel' && WheelApp.chartInstance) {
                        // Re-render chart if theme might have changed or view resized
                        WheelApp.renderChart();
                    }
                    if (appName === 'rituals') {
                        // Re-render stats charts if needed
                        RitualsApp.renderStatsView(); // This includes chart rendering
                    }

                } else {
                    console.error(`App container not found for: ${appName}`);
                }

                // Update active state for main nav button (redundant with listener, but safe)
                const navButtons = document.querySelectorAll('.main-nav button');
                 navButtons.forEach(btn => btn.classList.remove('active'));
                 const activeBtn = document.getElementById(`nav-${appName}`);
                 if(activeBtn) activeBtn.classList.add('active');

            }
        };

        // ========================================================================
        // == APP 1: Roue de la Vie (Encapsulated & Prefixed) =====================
        // ========================================================================
        const WheelApp = {
            // --- Constants & Icons ---
            deleteIcon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg>`,
            noteIcon: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg>`,
            helpIcon: `<span class="wheel-help-icon" aria-hidden="true" tabindex="0">?</span>`,

            // --- Default Data & Tooltips ---
            defaultPillarsData: [
                 { id: "sante", name: "Santé", tooltip: "Bien-être physique et mental général.", subPillars: [
                     { id: "sante-phy", name: "Physique", score: 5, note: "", goal: 10, isAction: false, tooltip: "Activité physique, énergie, absence de douleur, forme." },
                     { id: "sante-men", name: "Mental", score: 5, note: "", goal: 10, isAction: false, tooltip: "Clarté d'esprit, gestion du stress, santé émotionnelle." },
                     { id: "sante-som", name: "Sommeil", score: 5, note: "", goal: 10, isAction: false, tooltip: "Qualité et quantité du sommeil récupérateur." },
                     { id: "sante-nut", name: "Nutrition", score: 5, note: "", goal: 10, isAction: false, tooltip: "Équilibre et qualité de l'alimentation." },
                     { id: "sante-ene", name: "Énergie", score: 5, note: "", goal: 10, isAction: false, tooltip: "Niveau de vitalité et d'endurance au quotidien." }
                 ]},
                 { id: "famille", name: "Famille", tooltip: "Relations avec les membres de la famille proche.", subPillars: [
                     { id: "fam-pro", name: "Proches", score: 5, note: "", goal: 10, isAction: false, tooltip: "Qualité des liens avec le conjoint, enfants, parents..." },
                     { id: "fam-com", name: "Communication", score: 5, note: "", goal: 10, isAction: false, tooltip: "Facilité et ouverture dans les échanges familiaux." },
                     { id: "fam-tmp", name: "Temps passé", score: 5, note: "", goal: 10, isAction: false, tooltip: "Quantité et qualité du temps partagé en famille." },
                     { id: "fam-sou", name: "Soutien", score: 5, note: "", goal: 10, isAction: false, tooltip: "Sentiment de soutien mutuel reçu et donné." },
                     { id: "fam-har", name: "Harmonie", score: 5, note: "", goal: 10, isAction: false, tooltip: "Climat général, résolution des conflits, entente." }
                 ]},
                 { id: "finances", name: "Finances", tooltip: "Gestion de l'argent et sécurité financière.", subPillars: [
                     { id: "fin-0", name: "Revenus", score: 5, note: "", goal: 10, isAction: false, tooltip: "Suffisance et satisfaction vis-à-vis des rentrées d'argent." },
                     { id: "fin-1", name: "Épargne", score: 5, note: "", goal: 10, isAction: false, tooltip: "Capacité à mettre de l'argent de côté régulièrement." },
                     { id: "fin-2", name: "Dépenses", score: 5, note: "", goal: 10, isAction: false, tooltip: "Maîtrise du budget et des sorties d'argent." },
                     { id: "fin-3", name: "Investissements", score: 5, note: "", goal: 10, isAction: false, tooltip: "Stratégies pour faire fructifier l'argent (si applicable)." },
                     { id: "fin-4", name: "Sécurité", score: 5, note: "", goal: 10, isAction: false, tooltip: "Sentiment de sécurité financière face aux imprévus." }
                 ]},
                 { id: "carriere", name: "Carrière", tooltip: "Travail, profession, activité principale.", subPillars: [
                     { id: "car-0", name: "Satisfaction", score: 5, note: "", goal: 10, isAction: false, tooltip: "Plaisir et épanouissement dans le travail actuel." },
                     { id: "car-1", name: "Progression", score: 5, note: "", goal: 10, isAction: false, tooltip: "Opportunités d'évolution et de développement professionnel." },
                     { id: "car-2", name: "Équilibre", score: 5, note: "", goal: 10, isAction: false, tooltip: "Harmonie entre vie professionnelle et vie personnelle." },
                     { id: "car-3", name: "Compétences", score: 5, note: "", goal: 10, isAction: false, tooltip: "Utilisation et développement des compétences." },
                     { id: "car-4", name: "Reconnaissance", score: 5, note: "", goal: 10, isAction: false, tooltip: "Sentiment d'être reconnu et valorisé pour son travail." }
                 ]},
                 { id: "loisirs", name: "Loisirs", tooltip: "Activités de détente, passions et temps libre.", subPillars: [
                     { id: "loi-0", name: "Temps libre", score: 5, note: "", goal: 10, isAction: false, tooltip: "Disponibilité de temps pour soi et ses activités." },
                     { id: "loi-1", name: "Passions", score: 5, note: "", goal: 10, isAction: false, tooltip: "Pratique d'activités qui passionnent et ressourcent." },
                     { id: "loi-2", name: "Détente", score: 5, note: "", goal: 10, isAction: false, tooltip: "Capacité à se relaxer et déconnecter." },
                     { id: "loi-3", name: "Créativité", score: 5, note: "", goal: 10, isAction: false, tooltip: "Expression de sa créativité (arts, projets...)." },
                     { id: "loi-4", name: "Social", score: 5, note: "", goal: 10, isAction: false, tooltip: "Activités sociales et divertissements hors relations proches." }
                 ]},
                 { id: "devperso", name: "Développement perso", tooltip: "Croissance personnelle, apprentissage et objectifs.", subPillars: [
                     { id: "dev-0", name: "Apprentissage", score: 5, note: "", goal: 10, isAction: false, tooltip: "Acquisition de nouvelles connaissances ou compétences." },
                     { id: "dev-1", name: "Objectifs", score: 5, note: "", goal: 10, isAction: false, tooltip: "Clarté et poursuite des objectifs personnels." },
                     { id: "dev-2", name: "Confiance", score: 5, note: "", goal: 10, isAction: false, tooltip: "Niveau de confiance en soi et en ses capacités." },
                     { id: "dev-3", name: "Résilience", score: 5, note: "", goal: 10, isAction: false, tooltip: "Capacité à faire face aux difficultés et à rebondir." },
                     { id: "dev-4", name: "Clarté", score: 5, note: "", goal: 10, isAction: false, tooltip: "Connaissance de soi, de ses valeurs et de sa direction." }
                 ]},
                 { id: "relations", name: "Relations sociales", tooltip: "Liens avec les amis, collègues, communauté.", subPillars: [
                     { id: "rel-0", name: "Amis", score: 5, note: "", goal: 10, isAction: false, tooltip: "Qualité et profondeur des amitiés." },
                     { id: "rel-1", name: "Réseau", score: 5, note: "", goal: 10, isAction: false, tooltip: "Étendue et qualité du réseau social et professionnel." },
                     { id: "rel-2", name: "Écoute", score: 5, note: "", goal: 10, isAction: false, tooltip: "Capacité à écouter activement les autres." },
                     { id: "rel-3", name: "Partage", score: 5, note: "", goal: 10, isAction: false, tooltip: "Facilité à partager et échanger avec les autres." },
                     { id: "rel-4", name: "Qualité", score: 5, note: "", goal: 10, isAction: false, tooltip: "Satisfaction générale de la qualité des interactions sociales." }
                 ]},
                 { id: "cadrevie", name: "Cadre de vie", tooltip: "Environnement matériel et organisationnel.", subPillars: [
                     { id: "cad-0", name: "Logement", score: 5, note: "", goal: 10, isAction: false, tooltip: "Satisfaction vis-à-vis du lieu de vie." },
                     { id: "cad-1", name: "Environnement", score: 5, note: "", goal: 10, isAction: false, tooltip: "Appréciation de l'environnement proche (quartier, nature...)." },
                     { id: "cad-2", name: "Organisation", score: 5, note: "", goal: 10, isAction: false, tooltip: "Niveau d'ordre et d'organisation de ses espaces." },
                     { id: "cad-3", name: "Confort", score: 5, note: "", goal: 10, isAction: false, tooltip: "Sentiment de confort et de bien-être matériel." },
                     { id: "cad-4", name: "Esthétique", score: 5, note: "", goal: 10, isAction: false, tooltip: "Appréciation de la beauté et de l'harmonie de son cadre." }
                 ]}
            ],

            // --- Global Variables ---
            pillars: [],
            history: [],
            currentPillarIndex: 0,
            chartInstance: null,
            isPremium: false,
            longPressTimer: null,
            PREMIUM_PRESS_DURATION: 10000, // 10 seconds for premium activation
            pillarColors: [
                'var(--wheel-pillar-color-0)', 'var(--wheel-pillar-color-1)', 'var(--wheel-pillar-color-2)', 'var(--wheel-pillar-color-3)',
                'var(--wheel-pillar-color-4)', 'var(--wheel-pillar-color-5)', 'var(--wheel-pillar-color-6)', 'var(--wheel-pillar-color-7)'
            ],
            MINI_TREND_COUNT: 7, // Number of entries for the mini trend graph

            // --- DOM References (cached in init) ---
            dom: {},

            // --- Utility Functions ---
            getCssVar: function(varName) {
                const appWheelElement = document.getElementById('app-wheel');
                if (!appWheelElement) return '';
                return getComputedStyle(appWheelElement).getPropertyValue(varName).trim();
            },

            generateId: function(prefix = 'item') {
                return `${prefix.toLowerCase().replace(/[^a-z0-9]+/g, '-')}-${Date.now().toString(36)}-${Math.random().toString(36).substr(2, 5)}`;
            },

            showNotification: function(message, duration = 3000) {
                if (!this.dom.notification) return;
                this.dom.notification.textContent = message;
                this.dom.notification.style.display = 'block';
                if (this.dom.notification.timer) clearTimeout(this.dom.notification.timer);
                this.dom.notification.timer = setTimeout(() => {
                    if (this.dom.notification) this.dom.notification.style.display = 'none';
                }, duration);
            },

            debounce: function(func, wait) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            },

            // --- Core Application Logic ---
            init: function() {
                console.log("WheelApp Initializing...");
                this.cacheDomElements();
                this.debouncedSaveData = this.debounce(this.saveData, 500);
                this.debouncedUpdateScoresDisplay = this.debounce(this.updateScoresDisplay, 150);

                try {
                    this.loadData();
                    this.setupTheme();
                    this.updatePremiumUI();

                    const welcomeDismissed = localStorage.getItem('wheelOfLife_welcomeDismissed') === 'true';

                    if (!welcomeDismissed && this.dom.welcomeView) {
                        this.dom.welcomeView.style.display = 'block';
                        if (this.dom.inputView) this.dom.inputView.style.display = 'none';
                        if (this.dom.chartView) this.dom.chartView.style.display = 'none';
                        if (this.pillars.length === 0) {
                             this.handleNoPillars();
                        }
                    } else {
                        if (this.dom.welcomeView) this.dom.welcomeView.style.display = 'none';
                        if (this.pillars.length > 0) {
                            this.renderPillar();
                            this.showInputView();
                        } else {
                            this.handleNoPillars();
                        }
                    }
                    this.addEventListeners();
                } catch (error) {
                    console.error("Erreur critique lors de l'initialisation de WheelApp :", error);
                    this.showNotification("Erreur critique au chargement de la Roue. Certaines fonctionnalités peuvent être indisponibles.", 6000);
                     if (this.dom.welcomeView) this.dom.welcomeView.style.display = 'none';
                     if (this.dom.inputView) this.dom.inputView.style.display = 'none';
                     if (this.dom.chartView) this.dom.chartView.style.display = 'none';
                } finally {
                    if (this.dom.loadingMessage) this.dom.loadingMessage.style.display = 'none';
                }
                console.log("WheelApp Initialized.");
            },

            cacheDomElements: function() {
                this.dom = {
                    appContainer: document.getElementById('app-wheel'),
                    welcomeView: document.getElementById('wheel-welcomeView'),
                    inputView: document.getElementById('wheel-inputView'),
                    chartView: document.getElementById('wheel-chartView'),
                    pillarDisplay: document.getElementById('wheel-pillarDisplay'),
                    globalScoreDisplay: document.getElementById('wheel-globalScore'),
                    pillarAverageScoreDisplay: document.getElementById('wheel-pillarAverageScore'),
                    prevBtn: document.getElementById('wheel-prevBtn'),
                    nextBtn: document.getElementById('wheel-nextBtn'),
                    radarChartCanvas: document.getElementById('wheel-radarChart'),
                    historyContent: document.getElementById('wheel-historyContent'),
                    overlay: document.getElementById('wheel-overlay'),
                    themeCheckbox: document.getElementById('wheel-theme-checkbox'),
                    customizationContent: document.getElementById('wheel-customizationContent'),
                    showChartBtn: document.getElementById('wheel-showChartBtn'),
                    notePopup: document.getElementById('wheel-notePopup'),
                    notePopupSubPillarName: document.getElementById('wheel-notePopupSubPillarName'),
                    notePopupTextarea: document.getElementById('wheel-notePopupTextarea'),
                    notePopupActionKeyCheckbox: document.getElementById('wheel-notePopupActionKey'),
                    saveNoteBtn: document.getElementById('wheel-saveNoteBtn'),
                    historyPopup: document.getElementById('wheel-historyPopup'),
                    historyScrollBtn: document.getElementById('wheel-historyScrollToBottomBtn'),
                    personalizeBtn: document.getElementById('wheel-personalizeBtn'),
                    importBtn: document.getElementById('wheel-importBtn'),
                    appLogo: document.getElementById('wheel-appLogo'),
                    loadingMessage: document.getElementById('wheel-loadingMessage'),
                    notification: document.getElementById('wheel-notification'),
                    actionKeysPopup: document.getElementById('wheel-actionKeysPopup'),
                    actionKeysContent: document.getElementById('wheel-actionKeysContent'),
                    miniTrendGraphContainer: document.getElementById('wheel-miniTrendGraphContainer'),
                    pillarNavigation: document.getElementById('wheel-pillarNavigation'),
                    compareControls: document.getElementById('wheel-compareControls'),
                    helpPersonalizeSection: document.getElementById('wheel-helpPersonalizeSection'),
                    helpImportSection: document.getElementById('wheel-helpImportSection'),
                    customizationPopup: document.getElementById('wheel-customizationPopup'), // Added
                    helpPopup: document.getElementById('wheel-helpPopup') // Added
                };
            },

            handleNoPillars: function() {
                if (!this.dom.inputView || !this.dom.pillarDisplay) return;
                this.dom.inputView.style.display = 'block';
                if (this.dom.chartView) this.dom.chartView.style.display = 'none';
                this.dom.pillarDisplay.innerHTML = "<p class='wheel-text-center'>Aucun pilier défini. Veuillez recharger l'application ou réinitialiser.</p>";
                if (this.dom.globalScoreDisplay) this.dom.globalScoreDisplay.textContent = `Note globale : - / 20`;
                if (this.dom.pillarAverageScoreDisplay) this.dom.pillarAverageScoreDisplay.textContent = `Moyenne Pilier : - / 10`;
                if (this.dom.prevBtn) this.dom.prevBtn.disabled = true;
                if (this.dom.nextBtn) this.dom.nextBtn.disabled = true;
                if (this.dom.showChartBtn) this.dom.showChartBtn.disabled = true;
                this.dom.inputView.style.setProperty('--wheel-pillar-border-color', 'transparent');
                if (this.chartInstance) {
                    this.chartInstance.destroy();
                    this.chartInstance = null;
                }
            },

            loadData: function() {
                const storedPillars = localStorage.getItem('wheelOfLife_pillars');
                const storedHistory = localStorage.getItem('wheelOfLife_history');

                try {
                    const parsedPillars = storedPillars ? JSON.parse(storedPillars) : null;
                    this.pillars = parsedPillars && Array.isArray(parsedPillars) && parsedPillars.length > 0
                              ? this.migrateDataStructure(parsedPillars)
                              : JSON.parse(JSON.stringify(this.defaultPillarsData));
                } catch (e) {
                    console.error("Erreur lors du chargement des piliers (WheelApp), réinitialisation:", e);
                    this.pillars = JSON.parse(JSON.stringify(this.defaultPillarsData));
                    localStorage.removeItem('wheelOfLife_pillars');
                    this.showNotification("Données des piliers corrompues. Réinitialisation.");
                }

                try {
                    const parsedHistory = storedHistory ? JSON.parse(storedHistory) : [];
                    this.history = Array.isArray(parsedHistory) ? parsedHistory : [];
                     this.history = this.history.filter(entry => entry && entry.date && entry.timestamp && Array.isArray(entry.scores));
                    this.history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                } catch (e) {
                    console.error("Erreur lors du chargement de l'historique (WheelApp), réinitialisation:", e);
                    this.history = [];
                    localStorage.removeItem('wheelOfLife_history');
                    this.showNotification("Historique corrompu. Réinitialisation.");
                }

                 if (!Array.isArray(this.pillars) || this.pillars.length === 0) {
                     console.warn("Pillars array invalid after load attempt (WheelApp), forcing defaults.");
                     this.pillars = JSON.parse(JSON.stringify(this.defaultPillarsData));
                 }

                this.currentPillarIndex = 0;
                const storedPremium = localStorage.getItem('wheelOfLife_premiumStatus');
                this.isPremium = storedPremium === 'true';
            },

            migrateDataStructure: function(loadedPillars) {
                if (!Array.isArray(loadedPillars)) return JSON.parse(JSON.stringify(this.defaultPillarsData));

                const defaultMap = new Map();
                this.defaultPillarsData.forEach(dp => {
                    const subMap = new Map();
                    dp.subPillars.forEach(dsp => subMap.set(dsp.id, dsp));
                    defaultMap.set(dp.id, { pillar: dp, subPillars: subMap });
                });

                return loadedPillars.map((p, pIdx) => {
                    const pillarBase = p || {};
                    const defaultPillarData = defaultMap.get(pillarBase.id)?.pillar || this.defaultPillarsData[pIdx] || {};
                    const defaultSubPillarsMap = defaultMap.get(pillarBase.id)?.subPillars || new Map();

                    return {
                        id: pillarBase.id || defaultPillarData.id || this.generateId(pillarBase.name || `pillar-${pIdx}`),
                        name: pillarBase.name || defaultPillarData.name || `Pilier ${pIdx + 1}`,
                        tooltip: pillarBase.tooltip || defaultPillarData.tooltip || "",
                        subPillars: Array.isArray(pillarBase.subPillars) ? pillarBase.subPillars.map((sp, spIdx) => {
                            const subPillarBase = typeof sp === 'string' ? { name: sp } : (sp || {});
                            const defaultSubPillarData = defaultSubPillarsMap.get(subPillarBase.id) || defaultPillarData.subPillars?.[spIdx] || {};

                            return {
                                id: subPillarBase.id || defaultSubPillarData.id || this.generateId((pillarBase.id || `p${pIdx}`) + '-' + (subPillarBase.name || `sub-${spIdx}`)),
                                name: subPillarBase.name || defaultSubPillarData.name || `Sous-pilier ${spIdx + 1}`,
                                score: (subPillarBase.score !== undefined && !isNaN(parseInt(subPillarBase.score))) ? parseInt(subPillarBase.score) : 5,
                                note: subPillarBase.note || "",
                                goal: (subPillarBase.goal !== undefined && !isNaN(parseInt(subPillarBase.goal))) ? parseInt(subPillarBase.goal) : 10,
                                isAction: typeof subPillarBase.isAction === 'boolean' ? subPillarBase.isAction : false,
                                tooltip: subPillarBase.tooltip || defaultSubPillarData.tooltip || ""
                            };
                        }) : (defaultPillarData.subPillars ? JSON.parse(JSON.stringify(defaultPillarData.subPillars)) : [])
                    };
                }).filter(p => p.name && p.id);
            },

            saveData: function() {
                try {
                    localStorage.setItem('wheelOfLife_pillars', JSON.stringify(this.pillars));
                    localStorage.setItem('wheelOfLife_history', JSON.stringify(this.history));
                } catch (e) {
                    console.error("Erreur lors de la sauvegarde (WheelApp) :", e);
                    if (e.name === 'QuotaExceededError') {
                        this.showNotification("Erreur: Espace de stockage local plein. Impossible de sauvegarder.", 5000);
                    } else {
                        this.showNotification("Erreur : Impossible de sauvegarder les données.", 5000);
                    }
                }
            },

            savePremiumStatus: function() {
                localStorage.setItem('wheelOfLife_premiumStatus', this.isPremium);
            },

            activatePremium: function() {
                if (this.isPremium) return;
                this.isPremium = true;
                this.savePremiumStatus();
                this.updatePremiumUI();
                this.showNotification("Mode Premium activé ! Fonctionnalités supplémentaires débloquées.", 4000);
            },

            updatePremiumUI: function() {
                const displayValue = this.isPremium ? 'inline-block' : 'none';
                if (this.dom.personalizeBtn) this.dom.personalizeBtn.style.display = displayValue;
                if (this.dom.importBtn) this.dom.importBtn.style.display = displayValue;
                 const exportBtn = this.dom.historyPopup?.querySelector('button[onclick="WheelApp.exportData()"]');
                 if (exportBtn) exportBtn.style.display = displayValue;

                if (this.dom.helpPersonalizeSection) this.dom.helpPersonalizeSection.style.display = this.isPremium ? 'list-item' : 'none';
                if (this.dom.helpImportSection) this.dom.helpImportSection.style.display = this.isPremium ? 'list-item' : 'none';
            },

            handleLogoPressStart: function(event) {
                event.preventDefault();
                clearTimeout(this.longPressTimer);
                this.longPressTimer = setTimeout(() => this.activatePremium(), this.PREMIUM_PRESS_DURATION);
            },

            handleLogoPressEnd: function() {
                clearTimeout(this.longPressTimer);
            },

            renderPillar: function() {
                if (!this.pillars || this.pillars.length === 0) {
                    this.handleNoPillars();
                    return;
                }
                if (this.currentPillarIndex < 0 || this.currentPillarIndex >= this.pillars.length) {
                    this.currentPillarIndex = 0;
                }

                const pillar = this.pillars[this.currentPillarIndex];
                const pillarColor = this.pillarColors[this.currentPillarIndex % this.pillarColors.length];
                if (this.dom.inputView) this.dom.inputView.style.setProperty('--wheel-pillar-border-color', pillarColor);

                if (this.dom.pillarNavigation) {
                    this.dom.pillarNavigation.innerHTML = this.pillars.map((p, idx) => `
                        <button class="wheel-pillar-nav-button ${idx === this.currentPillarIndex ? 'active' : ''}"
                                onclick="WheelApp.navigateToPillar(${idx})"
                                aria-label="Aller au pilier ${p.name}"
                                aria-current="${idx === this.currentPillarIndex ? 'true' : 'false'}">
                            ${p.name}
                        </button>
                    `).join('');
                }

                 const createTooltip = (text) => {
                     if (!text) return '';
                     return `<span class="wheel-help-icon" aria-hidden="true" tabindex="0">?<span class="wheel-tooltiptext">${text}</span></span>`;
                 };

                 let pillarHTML = `
                     <h3 id="wheel-pillar-title">
                         <span>${pillar.name}</span>
                         ${createTooltip(pillar.tooltip)}
                         <span style="font-weight:normal; font-size: 0.8em; margin-left: auto;">(${this.currentPillarIndex + 1}/${this.pillars.length})</span>
                     </h3>
                     <div class="wheel-pillar-actions">
                         <button onclick="WheelApp.applyGoalToAllSubPillars('${pillar.id}', 10)" aria-label="Appliquer l'objectif 10 à tous les sous-piliers de ${pillar.name}">Objectif 10 pour tous</button>
                         <button onclick="WheelApp.resetPillarScores('${pillar.id}', 5)" aria-label="Réinitialiser les notes de tous les sous-piliers de ${pillar.name} à 5">Notes à 5</button>
                     </div>
                 `;

                if (!pillar.subPillars || pillar.subPillars.length === 0) {
                    pillarHTML += "<p class='wheel-text-center'>Ce pilier n'a pas de sous-piliers.</p>";
                } else {
                    pillar.subPillars.forEach((subPillar, index) => {
                        const displayScore = (typeof subPillar.score === 'number' && !isNaN(subPillar.score)) ? subPillar.score : 5;
                        const displayGoal = (typeof subPillar.goal === 'number' && !isNaN(subPillar.goal)) ? subPillar.goal : 10;

                        pillarHTML += `
                            <div class="wheel-sub-pillar" id="wheel-subpillar-div-${subPillar.id}">
                                <div class="wheel-sub-pillar-header">
                                    <label for="wheel-range-${subPillar.id}" id="wheel-label-${subPillar.id}">
                                        <span>${subPillar.name}</span>
                                        ${createTooltip(subPillar.tooltip)}
                                    </label>
                                    <div class="wheel-sub-pillar-controls">
                                        <input type="range" id="wheel-range-${subPillar.id}" min="1" max="10" value="${displayScore}" oninput="WheelApp.updateScore('${pillar.id}', '${subPillar.id}', this.value, true)" aria-labelledby="wheel-label-${subPillar.id} wheel-slider-value-${subPillar.id}" aria-valuemin="1" aria-valuemax="10" aria-valuenow="${displayScore}">
                                        <output class="wheel-slider-value" id="wheel-slider-value-${subPillar.id}" for="wheel-range-${subPillar.id}">${displayScore}</output>
                                    </div>
                                </div>
                                <div class="wheel-sub-pillar-details">
                                    <div class="wheel-detail-group">
                                        <label for="wheel-goal-${subPillar.id}">Objectif:</label>
                                        <input type="number" id="wheel-goal-${subPillar.id}" min="1" max="10" value="${displayGoal}" onchange="WheelApp.updateGoal('${pillar.id}', '${subPillar.id}', this.value)" aria-label="Objectif pour ${subPillar.name}">
                                    </div>
                                    <div class="wheel-detail-group">
                                        <button class="wheel-note-button" onclick="WheelApp.openNotePopup('${pillar.id}', '${subPillar.id}')" aria-label="Ajouter ou modifier une note pour ${subPillar.name}">
                                            ${this.noteIcon}
                                        </button>
                                    </div>
                                </div>
                            </div>`;
                    });
                }
                if (this.dom.pillarDisplay) this.dom.pillarDisplay.innerHTML = pillarHTML;

                this.updateNavigationButtons();
                this.updateScoresDisplay();
                if (this.dom.showChartBtn) this.dom.showChartBtn.disabled = false;
            },

            findSubPillar: function(pillarId, subPillarId) {
                const pillar = this.pillars.find(p => p.id === pillarId);
                if (!pillar || !Array.isArray(pillar.subPillars)) {
                    console.warn(`Pillar not found or invalid (WheelApp): ${pillarId}`);
                    return null;
                }
                const subPillar = pillar.subPillars.find(sp => sp.id === subPillarId);
                 if (!subPillar) {
                     console.warn(`SubPillar not found (WheelApp): ${subPillarId} in pillar ${pillarId}`);
                 }
                return subPillar;
            },

            updateScore: function(pillarId, subPillarId, value, fromInput = false) {
                const score = parseInt(value);
                if (isNaN(score) || score < 1 || score > 10) {
                     console.warn(`Invalid score value received (WheelApp): ${value}`);
                     return;
                }

                const subPillar = this.findSubPillar(pillarId, subPillarId);
                if (subPillar) {
                    subPillar.score = score;
                    if (fromInput) {
                        const output = document.getElementById(`wheel-slider-value-${subPillarId}`);
                        if (output) output.textContent = score;
                        const rangeInput = document.getElementById(`wheel-range-${subPillarId}`);
                        if (rangeInput) rangeInput.setAttribute('aria-valuenow', score);
                    }
                    this.debouncedUpdateScoresDisplay();
                    this.debouncedSaveData();
                }
            },

             updateNote: function(pillarId, subPillarId, noteValue, isActionValue) {
                 const subPillar = this.findSubPillar(pillarId, subPillarId);
                 if (subPillar) {
                     subPillar.note = noteValue.trim();
                     subPillar.isAction = !!isActionValue;
                     this.debouncedSaveData();
                 }
             },

            updateGoal: function(pillarId, subPillarId, value) {
                const goal = parseInt(value);
                const input = document.getElementById(`wheel-goal-${subPillarId}`);
                const subPillar = this.findSubPillar(pillarId, subPillarId);

                if (subPillar) {
                    if (!isNaN(goal) && goal >= 1 && goal <= 10) {
                        subPillar.goal = goal;
                        this.debouncedSaveData();
                    } else {
                        if (input) input.value = subPillar.goal !== undefined ? subPillar.goal : 10;
                        this.showNotification("L'objectif doit être un nombre entre 1 et 10.", 3000);
                    }
                }
            },

             applyGoalToAllSubPillars: function(pillarId, goalValue) {
                 const pillar = this.pillars.find(p => p.id === pillarId);
                 if (!pillar || !Array.isArray(pillar.subPillars)) return;

                 let changed = false;
                 pillar.subPillars.forEach(sp => {
                     if (sp.goal !== goalValue) {
                         sp.goal = goalValue;
                         const input = document.getElementById(`wheel-goal-${sp.id}`);
                         if (input) input.value = goalValue;
                         changed = true;
                     }
                 });

                 if (changed) {
                     this.debouncedSaveData();
                     this.showNotification(`Objectif ${goalValue} appliqué à tous les sous-piliers de "${pillar.name}".`);
                 } else {
                     this.showNotification(`Tous les objectifs étaient déjà à ${goalValue}.`);
                 }
             },

             resetPillarScores: function(pillarId, scoreValue) {
                 const pillar = this.pillars.find(p => p.id === pillarId);
                 if (!pillar || !Array.isArray(pillar.subPillars)) return;

                 let changed = false;
                 pillar.subPillars.forEach(sp => {
                     if (sp.score !== scoreValue) {
                         sp.score = scoreValue;
                         const rangeInput = document.getElementById(`wheel-range-${sp.id}`);
                         const output = document.getElementById(`wheel-slider-value-${sp.id}`);
                         if (rangeInput) {
                             rangeInput.value = scoreValue;
                             rangeInput.setAttribute('aria-valuenow', scoreValue);
                         }
                         if (output) output.textContent = scoreValue;
                         changed = true;
                     }
                 });

                 if (changed) {
                     this.debouncedUpdateScoresDisplay();
                     this.debouncedSaveData();
                     this.showNotification(`Notes réinitialisées à ${scoreValue} pour "${pillar.name}".`);
                 } else {
                      this.showNotification(`Toutes les notes étaient déjà à ${scoreValue}.`);
                 }
             },

            calculateAverages: function() {
                if (!this.pillars || this.pillars.length === 0) {
                    return { pillarAverages: [], globalScore: 0 };
                }
                const pillarAverages = this.pillars.map(pillar => {
                    if (!pillar.subPillars || pillar.subPillars.length === 0) return NaN;
                    const validScores = pillar.subPillars.map(sub => sub.score).filter(score => typeof score === 'number' && !isNaN(score));
                    if (validScores.length === 0) return NaN;
                    const sum = validScores.reduce((acc, score) => acc + score, 0);
                    return sum / validScores.length;
                });

                const validPillarAverages = pillarAverages.filter(avg => !isNaN(avg));
                const globalAverage = validPillarAverages.length > 0
                    ? validPillarAverages.reduce((sum, avg) => sum + avg, 0) / validPillarAverages.length
                    : 0;

                const globalScore = globalAverage * 2;

                return { pillarAverages, globalScore };
            },

            updateScoresDisplay: function() {
                if (!this.pillars || this.pillars.length === 0) {
                     if (this.dom.globalScoreDisplay) this.dom.globalScoreDisplay.textContent = `Note globale : - / 20`;
                     if (this.dom.pillarAverageScoreDisplay) this.dom.pillarAverageScoreDisplay.textContent = `Moyenne Pilier : - / 10`;
                     return;
                 }
                const { pillarAverages, globalScore } = this.calculateAverages();
                if (this.dom.globalScoreDisplay) this.dom.globalScoreDisplay.textContent = `Note globale : ${globalScore.toFixed(1)} / 20`;

                const currentPillarAverage = pillarAverages[this.currentPillarIndex];
                if (this.dom.pillarAverageScoreDisplay) this.dom.pillarAverageScoreDisplay.textContent = `Moyenne Pilier : ${!isNaN(currentPillarAverage) ? currentPillarAverage.toFixed(1) : '-'} / 10`;
            },

            navigateToPillar: function(index) {
                if (index === this.currentPillarIndex || index < 0 || index >= this.pillars.length) return;
                this.currentPillarIndex = index;
                this.renderPillar();
                this.dom.appContainer?.scrollTo({ top: 0, behavior: 'smooth' });
            },

            changePillar: function(direction) {
                if (!this.pillars || this.pillars.length <= 1) return;
                let newIndex = this.currentPillarIndex + direction;
                if (newIndex < 0) {
                    newIndex = this.pillars.length - 1;
                } else if (newIndex >= this.pillars.length) {
                    newIndex = 0;
                }
                this.navigateToPillar(newIndex);
            },

            updateNavigationButtons: function() {
                const numPillars = this.pillars ? this.pillars.length : 0;
                if (this.dom.prevBtn) this.dom.prevBtn.disabled = numPillars <= 1;
                if (this.dom.nextBtn) this.dom.nextBtn.disabled = numPillars <= 1;
            },

            historyScrollToBottom: function() {
                if (this.dom.historyPopup) {
                     const buttons = this.dom.historyPopup.querySelector('.wheel-popup-buttons');
                     if (buttons) {
                         buttons.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                     } else {
                         this.dom.historyPopup.scrollTo({ top: this.dom.historyPopup.scrollHeight, behavior: 'smooth' });
                     }
                }
            },

            showInputView: function() {
                if (this.dom.welcomeView) this.dom.welcomeView.style.display = 'none';
                if (this.dom.inputView) this.dom.inputView.style.display = 'block';
                if (this.dom.chartView) this.dom.chartView.style.display = 'none';

                if (this.pillars.length > 0 && this.currentPillarIndex >= 0 && this.currentPillarIndex < this.pillars.length) {
                    const pillarColor = this.pillarColors[this.currentPillarIndex % this.pillarColors.length];
                    if (this.dom.inputView) this.dom.inputView.style.setProperty('--wheel-pillar-border-color', pillarColor);
                } else {
                    if (this.dom.inputView) this.dom.inputView.style.setProperty('--wheel-pillar-border-color', 'transparent');
                }
                 const firstSlider = this.dom.inputView?.querySelector('input[type="range"]');
                 if (firstSlider) {
                     // firstSlider.focus();
                 } else if (this.dom.nextBtn && !this.dom.nextBtn.disabled) {
                     this.dom.nextBtn.focus();
                 }
            },

            startEvaluation: function() {
                localStorage.setItem('wheelOfLife_welcomeDismissed', 'true');
                if (this.dom.welcomeView) this.dom.welcomeView.style.display = 'none';

                if (this.pillars.length > 0) {
                    this.currentPillarIndex = 0;
                    this.renderPillar();
                } else {
                     this.handleNoPillars();
                     return;
                }
                this.showInputView();

                const firstSlider = this.dom.inputView?.querySelector('input[type="range"]');
                if (firstSlider) {
                   // firstSlider.focus();
                } else if (this.dom.nextBtn && !this.dom.nextBtn.disabled) {
                   this.dom.nextBtn.focus();
                } else if (this.dom.prevBtn && !this.dom.prevBtn.disabled) {
                   this.dom.prevBtn.focus();
                }
            },

            showChartView: function() {
                if (this.dom.welcomeView) this.dom.welcomeView.style.display = 'none';
                if (this.dom.inputView) this.dom.inputView.style.display = 'none';
                if (this.dom.chartView) this.dom.chartView.style.display = 'block';
                this.renderChart();
                this.dom.appContainer?.scrollTo({ top: 0, behavior: 'smooth' });
                const historyButton = this.dom.chartView?.querySelector('button[onclick^="WheelApp.openModal(\'wheel-historyPopup\'"]');
                if (historyButton) {
                     historyButton.focus();
                }
            },

            renderChart: function(comparisonData = null) {
                if (!this.dom.radarChartCanvas) return;
                const ctx = this.dom.radarChartCanvas.getContext('2d');
                if (!ctx) return;

                const themeTextColor = this.getCssVar('--wheel-text-color') || '#2c3e50';
                const themeSecondaryTextColor = this.getCssVar('--wheel-secondary-text-color') || '#34495e';
                const themeGridColor = this.getCssVar('--wheel-grid-color') || '#dbe4e9';
                const themeContainerBgColor = this.getCssVar('--wheel-container-bg') || 'white';
                const themeTooltipBgColor = this.getCssVar('--wheel-tooltip-bg') || 'rgba(52, 73, 94, 0.95)';
                const themeTooltipTextColor = this.getCssVar('--wheel-tooltip-text-color') || 'white';

                 const commonOptions = {
                     responsive: true,
                     maintainAspectRatio: true,
                     scales: {
                         r: {
                             min: 0,
                             max: 10,
                             ticks: { stepSize: 2, backdropColor: themeContainerBgColor, color: themeSecondaryTextColor, font: { size: 10 } },
                             pointLabels: { color: themeTextColor, font: { size: 11 } },
                             grid: { color: themeGridColor },
                             angleLines: { color: themeGridColor }
                         }
                     },
                     plugins: {
                         legend: { position: 'top', labels: { color: themeTextColor, usePointStyle: true, boxWidth: 10, padding: 15, font: { size: 11 } } },
                         tooltip: {
                             enabled: true,
                             backgroundColor: themeTooltipBgColor,
                             titleColor: themeTooltipTextColor,
                             bodyColor: themeTooltipTextColor,
                             borderColor: themeGridColor,
                             borderWidth: 1,
                             padding: 10,
                             cornerRadius: 4,
                             usePointStyle: true,
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) label += ': ';
                                     if (context.parsed.r !== null) label += context.parsed.r.toFixed(1);
                                     return label;
                                 }
                             }
                         }
                     },
                      animation: { duration: 0 },
                      elements: {
                         line: { borderWidth: 2.5 },
                         point: { radius: 4, hoverRadius: 6, pointStyle: 'circle' }
                     }
                 };

                let chartData;
                let chartOptions = commonOptions;

                if (comparisonData) {
                     const labels = comparisonData.labels;
                     chartData = {
                         labels: labels,
                         datasets: comparisonData.datasets.map((dataset, index) => ({
                             ...dataset,
                             backgroundColor: index === 0 ? (this.getCssVar('--wheel-chart-bg-color') || 'rgba(52,152,219,0.2)') : (this.getCssVar('--wheel-goal-bg-color') || 'rgba(231,76,60,0.1)'),
                             borderColor: index === 0 ? (this.getCssVar('--wheel-chart-border-color') || '#3498db') : (this.getCssVar('--wheel-goal-border-color') || '#e74c3c'),
                             pointBackgroundColor: index === 0 ? (this.getCssVar('--wheel-chart-border-color') || '#3498db') : (this.getCssVar('--wheel-goal-border-color') || '#e74c3c'),
                             pointBorderColor: '#fff',
                             pointHoverBackgroundColor: '#fff',
                             pointHoverBorderColor: index === 0 ? (this.getCssVar('--wheel-chart-border-color') || '#3498db') : (this.getCssVar('--wheel-goal-border-color') || '#e74c3c'),
                         }))
                     };
                     chartOptions.plugins.legend.labels.usePointStyle = true;

                } else {
                     if (!this.pillars || this.pillars.length === 0) {
                         if (this.chartInstance) { this.chartInstance.destroy(); this.chartInstance = null; }
                         return;
                     }
                    const { pillarAverages } = this.calculateAverages();
                     const pillarGoalsAverages = this.pillars.map(pillar => {
                         if (!pillar.subPillars || pillar.subPillars.length === 0) return NaN;
                         const validGoals = pillar.subPillars.map(sub => sub.goal).filter(goal => typeof goal === 'number' && !isNaN(goal));
                         if (validGoals.length === 0) return NaN;
                         const sum = validGoals.reduce((acc, goal) => acc + goal, 0);
                         return sum / validGoals.length;
                     });

                     const labels = this.pillars.map(p => p.name);
                     const scoreBgColor = this.getCssVar('--wheel-chart-bg-color') || 'rgba(52,152,219,0.2)';
                     const scoreBorderColor = this.getCssVar('--wheel-chart-border-color') || '#3498db';
                     const goalBgColor = this.getCssVar('--wheel-goal-bg-color') || 'rgba(231,76,60,0.1)';
                     const goalBorderColor = this.getCssVar('--wheel-goal-border-color') || '#e74c3c';

                     chartData = {
                         labels: labels,
                         datasets: [
                             {
                                 label: 'Score Actuel',
                                 data: pillarAverages.map(avg => isNaN(avg) ? 0 : avg),
                                 backgroundColor: scoreBgColor,
                                 borderColor: scoreBorderColor,
                                 pointBackgroundColor: scoreBorderColor,
                                 pointBorderColor: '#fff',
                                 pointHoverBackgroundColor: '#fff',
                                 pointHoverBorderColor: scoreBorderColor,
                             },
                             {
                                 label: 'Objectif Moyen',
                                 data: pillarGoalsAverages.map(avg => isNaN(avg) ? 0 : avg),
                                 backgroundColor: goalBgColor,
                                 borderColor: goalBorderColor,
                                 borderWidth: 1.5,
                                 borderDash: [6, 3],
                                 pointBackgroundColor: goalBorderColor,
                                 pointBorderColor: '#fff',
                                 pointHoverBackgroundColor: '#fff',
                                 pointHoverBorderColor: goalBorderColor,
                                 pointRadius: 3,
                                 pointHoverRadius: 5,
                             }
                         ]
                     };
                     chartOptions.plugins.legend.labels.usePointStyle = false;
                 }

                if (this.chartInstance) {
                     this.chartInstance.data = chartData;
                     this.chartInstance.options = chartOptions;
                     this.chartInstance.update('none');
                } else {
                     if (typeof Chart === 'undefined') {
                         console.error("Chart.js n'est pas chargé ! Impossible de créer le graphique.");
                         this.showNotification("Erreur: Impossible de charger la bibliothèque de graphiques.", 5000);
                         return;
                     }
                     this.chartInstance = new Chart(ctx, {
                         type: 'radar',
                         data: chartData,
                         options: chartOptions
                     });
                }
            },

            showChartAndSave: function() {
                if (!this.pillars || this.pillars.length === 0) {
                    this.showNotification("Aucun pilier à afficher ou sauvegarder.");
                    return;
                }
                const { pillarAverages } = this.calculateAverages();
                this.saveToHistory(pillarAverages);
                this.showChartView();
                this.showNotification("Évaluation sauvegardée avec succès.");
            },

            saveToHistory: function(currentAverages) {
                 const timestamp = Date.now();
                 const twentyFourHoursInMillis = 24 * 60 * 60 * 1000;

                 const scoresData = this.pillars.map((p, index) => ({
                     pillarId: p.id,
                     pillarName: p.name,
                     average: (!isNaN(currentAverages[index]) ? currentAverages[index] : 0),
                     subPillars: JSON.parse(JSON.stringify(p.subPillars || []))
                 }));

                 const newEntry = {
                     id: `hist-${timestamp}-${Math.random().toString(36).substr(2, 5)}`,
                     date: new Date(timestamp).toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' }),
                     timestamp: timestamp,
                     scores: scoresData
                 };

                 this.history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                 const lastEntry = this.history.length > 0 ? this.history[0] : null;

                 if (lastEntry && (timestamp - (lastEntry.timestamp || 0)) < twentyFourHoursInMillis) {
                     console.log("Remplacement de l'entrée récente (< 24h) (WheelApp).");
                     this.history[0] = newEntry;
                 } else {
                     console.log("Ajout d'une nouvelle entrée à l'historique (WheelApp).");
                     this.history.push(newEntry);
                     this.history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                 }

                 const MAX_HISTORY_ENTRIES = 100;
                 if (this.history.length > MAX_HISTORY_ENTRIES) {
                     this.history = this.history.slice(0, MAX_HISTORY_ENTRIES);
                     console.log(`Historique limité aux ${MAX_HISTORY_ENTRIES} dernières entrées (WheelApp).`);
                 }
                 this.saveData();
            },

            showHistory: function() {
                if (!this.dom.historyContent || !this.dom.miniTrendGraphContainer || !this.dom.compareControls) return;
                this.dom.historyContent.innerHTML = '';
                this.dom.miniTrendGraphContainer.innerHTML = '';

                if (this.history.length === 0) {
                    this.dom.historyContent.innerHTML = "<p>Aucun historique disponible.</p>";
                    if (this.dom.historyScrollBtn) this.dom.historyScrollBtn.style.display = 'none';
                    this.dom.compareControls.style.display = 'none';
                    return;
                }

                this.renderMiniTrendGraph();

                const ul = document.createElement('ul');
                this.history.forEach((entry, index) => {
                    if (!entry || !entry.scores || !Array.isArray(entry.scores)) {
                        console.warn("Skipping invalid history entry (WheelApp):", entry);
                        return;
                    }

                    const li = document.createElement('li');
                    li.className = 'wheel-history-entry';

                    const entryAverages = entry.scores.map(s => s.average).filter(avg => !isNaN(avg));
                    const entryGlobalScore = entryAverages.length > 0 ? (entryAverages.reduce((sum, avg) => sum + avg, 0) / entryAverages.length * 2) : 0;

                    let entryHTML = `
                        <div style="display: flex; align-items: baseline; gap: 10px; margin-bottom: 5px;">
                             <input type="checkbox" class="wheel-history-compare-checkbox" data-index="${index}" onchange="WheelApp.updateCompareControls()" aria-label="Sélectionner l'entrée du ${entry.date} pour comparaison">
                             <strong>${entry.date || 'Date inconnue'}</strong>
                             <span style="font-size: 0.9em; color: var(--wheel-secondary-text-color);">(Score Global: ${entryGlobalScore.toFixed(1)}/20)</span>
                        </div>`;

                    const prevEntry = this.history[index + 1];

                    entryHTML += '<div class="wheel-history-scores">';
                    entry.scores.forEach(currentScore => {
                        entryHTML += `${currentScore.pillarName || 'Pilier inconnu'}: ${currentScore.average !== undefined ? currentScore.average.toFixed(1) : '-'}`;

                        if (prevEntry && prevEntry.scores && Array.isArray(prevEntry.scores)) {
                            const prevPillarScore = prevEntry.scores.find(ps => ps.pillarId === currentScore.pillarId);
                            if (prevPillarScore && prevPillarScore.average !== undefined && currentScore.average !== undefined) {
                                const diff = currentScore.average - prevPillarScore.average;
                                if (Math.abs(diff) > 0.05) {
                                    const diffClass = diff > 0 ? 'positive' : 'negative';
                                    const diffSign = diff > 0 ? '+' : '';
                                    entryHTML += ` <span class="wheel-score-diff ${diffClass}" title="vs ${prevPillarScore.average.toFixed(1)} le ${prevEntry.date || ''}">(${diffSign}${diff.toFixed(1)})</span>`;
                                }
                            }
                        }
                        entryHTML += '<br>';
                    });
                    entryHTML += '</div>';
                    li.innerHTML = entryHTML;
                    ul.appendChild(li);
                });

                this.dom.historyContent.appendChild(ul);
                this.dom.compareControls.style.display = 'block';
                this.updateCompareControls();

                if (this.dom.historyPopup && this.dom.historyScrollBtn) {
                    setTimeout(() => {
                         if (document.getElementById('wheel-historyPopup')) {
                             const isScrollable = this.dom.historyPopup.scrollHeight > this.dom.historyPopup.clientHeight;
                             this.dom.historyScrollBtn.style.display = isScrollable ? 'inline-block' : 'none';
                         }
                     }, 100);
                }
            },

            renderMiniTrendGraph: function() {
                 if (this.history.length < 2 || !this.dom.miniTrendGraphContainer) {
                     if(this.dom.miniTrendGraphContainer) this.dom.miniTrendGraphContainer.innerHTML = '';
                     return;
                 }

                 const trendData = this.history.slice(0, this.MINI_TREND_COUNT).reverse();
                 const scores = trendData.map(entry => {
                     const entryAverages = entry.scores.map(s => s.average).filter(avg => !isNaN(avg));
                     return entryAverages.length > 0 ? (entryAverages.reduce((sum, avg) => sum + avg, 0) / entryAverages.length * 2) : 0;
                 });

                 const maxValue = 20;
                 let graphHTML = `
                     <div class="wheel-mini-trend-graph">
                         <h5>Tendance Globale Récente (/20)</h5>
                         <div class="wheel-trend-bars">`;

                 scores.forEach((score, index) => {
                     const percentageHeight = maxValue > 0 ? (score / maxValue * 100) : 0;
                     const dateLabel = trendData[index].date.split(',')[0];
                     graphHTML += `
                         <div class="wheel-trend-bar-item" title="${trendData[index].date}: ${score.toFixed(1)}/20">
                              <div class="wheel-bar-value">${score.toFixed(1)}</div>
                             <div class="wheel-trend-bar" style="height: ${percentageHeight}%;">
                                 <span>${dateLabel}</span>
                             </div>
                         </div>`;
                 });

                 graphHTML += `</div></div>`;
                 this.dom.miniTrendGraphContainer.innerHTML = graphHTML;
             },

            updateCompareControls: function() {
                const selectedCheckboxes = this.dom.historyContent?.querySelectorAll('.wheel-history-compare-checkbox:checked');
                const compareBtn = document.getElementById('wheel-compareBtn');
                if (compareBtn && selectedCheckboxes) {
                     compareBtn.disabled = selectedCheckboxes.length !== 2;
                 }
            },

            compareSelectedEntries: function() {
                 const selectedCheckboxes = this.dom.historyContent?.querySelectorAll('.wheel-history-compare-checkbox:checked');
                 if (!selectedCheckboxes || selectedCheckboxes.length !== 2) {
                     this.showNotification("Veuillez sélectionner exactement deux évaluations à comparer.");
                     return;
                 }

                 const indices = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.index));
                 if (indices.some(isNaN) || indices.some(idx => idx < 0 || idx >= this.history.length)) {
                      this.showNotification("Erreur: Sélection invalide.");
                      console.error("Invalid indices for comparison (WheelApp):", indices);
                      return;
                  }

                 const entriesToCompare = [this.history[indices[0]], this.history[indices[1]]];
                 if (entriesToCompare.some(entry => !entry || !entry.scores)) {
                     this.showNotification("Erreur: Impossible de comparer les entrées sélectionnées (données manquantes).");
                     console.error("Invalid entries selected for comparison (WheelApp):", entriesToCompare);
                     return;
                 }

                 const currentPillarLabels = this.pillars.map(p => p.name);
                 const comparisonDatasets = entriesToCompare.map(entry => {
                     const data = currentPillarLabels.map(label => {
                         const currentPillar = this.pillars.find(p => p.name === label);
                         if (!currentPillar) return 0;
                         const historicalScore = entry.scores.find(s => s.pillarId === currentPillar.id);
                         return historicalScore ? (historicalScore.average || 0) : 0;
                     });
                     return { label: `Éval. ${entry.date}`, data: data };
                 });

                const comparisonChartData = { labels: currentPillarLabels, datasets: comparisonDatasets };
                this.closeModal('wheel-historyPopup');
                this.showChartView();
                this.renderChart(comparisonChartData);
                this.showNotification(`Comparaison des évaluations du ${entriesToCompare[0].date} et ${entriesToCompare[1].date}.`);
            },

             openActionKeysPopup: function() {
                 this.renderActionKeys();
                 this.openModal('wheel-actionKeysPopup');
             },

             renderActionKeys: function() {
                 if (!this.dom.actionKeysContent) return;
                 this.dom.actionKeysContent.innerHTML = '';
                 const actions = [];

                 this.history.forEach(entry => {
                     if (!entry || !entry.scores) return;
                     entry.scores.forEach(pillarScore => {
                         if (!pillarScore.subPillars) return;
                         pillarScore.subPillars.forEach(sp => {
                             if (sp.isAction && sp.note) {
                                 actions.push({
                                     date: entry.date,
                                     pillarName: pillarScore.pillarName,
                                     subPillarName: sp.name,
                                     note: sp.note,
                                 });
                             }
                         });
                     });
                 });

                 if (actions.length === 0) {
                     this.dom.actionKeysContent.innerHTML = '<p>Aucune action clé définie pour le moment.</p><p style="font-size: 0.9em;">Utilisez l\'icône <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:0.9em; height:0.9em; vertical-align: -0.1em;"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" /></svg> puis cochez la case "Marquer comme Action Clé".</p>';
                     return;
                 }

                 const ul = document.createElement('ul');
                 actions.forEach(action => {
                     const li = document.createElement('li');
                     li.className = 'wheel-action-key-entry';
                     li.innerHTML = `
                         <strong>${action.pillarName} > ${action.subPillarName}</strong>
                         <span style="font-size: 0.8em; color: var(--wheel-secondary-text-color); margin-left: 5px;">(${action.date})</span>
                         <div class="wheel-action-key-note">${action.note}</div>
                         `;
                     ul.appendChild(li);
                 });
                 this.dom.actionKeysContent.appendChild(ul);
             },

            copyHistory: function() {
                if (this.history.length === 0) {
                    this.showNotification("L'historique est vide, rien à copier.");
                    return;
                }
                try {
                     const historyForAI = this.history.map(entry => ({
                         ...entry,
                         scores: entry.scores.map(score => ({
                             ...score,
                             subPillars: score.subPillars.map(sp => ({ ...sp }))
                         }))
                     }));

                     const historyJson = JSON.stringify(historyForAI, null, 2);
                     const promptText = `Bonjour ! Voici mon historique d'évaluations de la Roue de la Vie, au format JSON. Chaque entrée représente une évaluation à une date donnée, avec les scores moyens par pilier et les détails (note, objectif, score) pour chaque sous-pilier.\n\nPeux-tu m'aider à analyser ces données pour :\n1. Identifier les tendances d'évolution (positives et négatives) dans les différents domaines de ma vie ?\n2. Repérer mes points forts et mes points faibles récurrents ?\n3. Me suggérer des pistes de réflexion ou d'action concrètes pour améliorer mon équilibre global et travailler sur les domaines les moins satisfaisants, en te basant sur mes notes et objectifs passés ?\n\nVoici les données :\n\n\`\`\`json\n${historyJson}\n\`\`\`\n\nMerci pour ton analyse et tes conseils !`;

                     navigator.clipboard.writeText(promptText).then(() => {
                         this.showNotification("Historique formaté et prompt pour IA copiés ! Collez dans votre IA préférée.", 5000);
                     }).catch(err => {
                         console.error("Erreur lors de la copie vers le presse-papiers (WheelApp) :", err);
                         this.showNotification("Erreur : Impossible de copier. Vérifiez les permissions du navigateur.", 4000);
                     });
                 } catch (error) {
                     console.error("Erreur lors de la préparation des données pour la copie (WheelApp) :", error);
                     this.showNotification("Erreur lors de la préparation des données pour la copie.", 4000);
                 }
            },

            exportData: function() {
                 if (!this.isPremium) {
                     this.showNotification("La fonction d'exportation est réservée aux utilisateurs Premium.");
                     return;
                 }
                 try {
                     const dataToExport = {
                         pillars: this.pillars,
                         history: this.history,
                         premiumStatus: this.isPremium,
                         exportTimestamp: new Date().toISOString()
                     };
                     const dataStr = JSON.stringify(dataToExport, null, 2);
                     const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     const dateStr = new Date().toISOString().slice(0, 10);
                     a.download = `roue_de_la_vie_export_${dateStr}.json`;
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                     URL.revokeObjectURL(url);
                     this.showNotification("Données exportées avec succès.");
                 } catch (error) {
                     console.error("Erreur lors de l'exportation JSON (WheelApp) :", error);
                     this.showNotification("Erreur lors de la création du fichier d'exportation.", 4000);
                 }
            },

            importData: function(event) {
                 if (!this.isPremium) {
                     this.showNotification("La fonction d'importation est réservée aux utilisateurs Premium.");
                     event.target.value = '';
                     return;
                 }

                 const file = event.target.files[0];
                 if (!file) {
                     this.showNotification("Aucun fichier sélectionné.");
                     return;
                 }
                 if (!file.type.match('application/json')) {
                     this.showNotification("Fichier invalide. Veuillez sélectionner un fichier JSON exporté.", 4000);
                     event.target.value = '';
                     return;
                 }

                 const reader = new FileReader();
                 reader.onload = (e) => { // Use arrow function to keep 'this' context
                     try {
                         const importedData = JSON.parse(e.target.result);
                         if (!importedData || typeof importedData !== 'object') {
                             throw new Error("Le contenu du fichier n'est pas un objet JSON valide.");
                         }

                         let importedPillars = null;
                         let importedHistory = null;
                         let importedPremium = null;

                         if (importedData.pillars && Array.isArray(importedData.pillars)) {
                             importedPillars = importedData.pillars;
                         } else {
                             console.warn("Données de piliers manquantes ou invalides dans l'import (WheelApp).");
                         }

                         if (importedData.history && Array.isArray(importedData.history)) {
                             importedHistory = importedData.history;
                         } else {
                             console.warn("Données d'historique manquantes ou invalides dans l'import (WheelApp).");
                         }

                          if (typeof importedData.premiumStatus === 'boolean') {
                             importedPremium = importedData.premiumStatus;
                         }

                         if (!confirm("Importer ces données remplacera votre configuration et historique actuels de la Roue de la Vie. Continuer ?")) {
                             event.target.value = '';
                             return;
                         }

                         if (importedPillars) {
                             this.pillars = this.migrateDataStructure(importedPillars);
                         } else {
                              this.pillars = JSON.parse(JSON.stringify(this.defaultPillarsData));
                              this.showNotification("Piliers non trouvés dans l'import, réinitialisation aux défauts.");
                         }

                         if (importedHistory) {
                              this.history = importedHistory.filter(entry => entry && entry.date && entry.timestamp && Array.isArray(entry.scores));
                              this.history.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                         } else {
                             this.history = [];
                         }

                          if (importedPremium !== null) {
                             this.isPremium = importedPremium;
                             this.savePremiumStatus();
                             this.updatePremiumUI();
                         }

                         this.saveData();
                         this.currentPillarIndex = 0;
                         this.renderPillar();
                         this.showHistory();
                         this.showChartView();
                         this.showNotification("Données importées et appliquées avec succès.");

                     } catch (err) {
                         console.error("Erreur lors de l'importation JSON (WheelApp) :", err);
                         this.showNotification(`Erreur d'importation: ${err.message}. Fichier invalide ou corrompu.`, 5000);
                     } finally {
                         event.target.value = '';
                     }
                 };

                 reader.onerror = () => {
                     this.showNotification("Erreur lors de la lecture du fichier.", 4000);
                     event.target.value = '';
                 };

                 reader.readAsText(file);
            },

            resetApp: function() {
                if (!confirm("ATTENTION : Êtes-vous absolument sûr de vouloir réinitialiser TOUTES les données de la Roue de la Vie (piliers, historique, notes, statut premium) ? Cette action est IRRÉVERSIBLE.")) {
                    return;
                }

                 localStorage.removeItem('wheelOfLife_pillars');
                 localStorage.removeItem('wheelOfLife_history');
                 localStorage.removeItem('wheelOfLife_premiumStatus');
                 // localStorage.removeItem('wheelOfLife_theme'); // Optionally reset theme

                this.pillars = JSON.parse(JSON.stringify(this.defaultPillarsData));
                this.history = [];
                this.isPremium = false;
                this.currentPillarIndex = 0;

                this.updatePremiumUI();
                this.renderPillar();
                this.showInputView();
                 if (this.chartInstance) { this.chartInstance.destroy(); this.chartInstance = null; }

                this.closeAllModals();
                this.showNotification("Application Roue de la Vie entièrement réinitialisée.", 4000);
                // No need to call saveData()
                 // window.location.reload(); // Could reload the whole page
            },

            // --- Modal Management ---
            openModal: function(modalId) {
                this.closeAllModals();
                const modal = document.getElementById(modalId);
                if (!modal) {
                     console.error(`Modal with ID ${modalId} not found (WheelApp).`);
                     return;
                 }

                if (modalId === 'wheel-historyPopup') {
                    this.showHistory();
                } else if (modalId === 'wheel-customizationPopup') {
                     if (!this.isPremium) {
                         this.showNotification("La personnalisation est une fonctionnalité Premium.");
                         return;
                     }
                    this.renderCustomizationForm();
                } else if (modalId === 'wheel-actionKeysPopup') {
                     this.renderActionKeys();
                 }

                if (this.dom.overlay) this.dom.overlay.style.display = 'flex';
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden', 'false');

                 const focusableElements = modal.querySelectorAll(
                     'button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])'
                 );
                 const firstFocusable = focusableElements[0];

                 if (firstFocusable) {
                     setTimeout(() => firstFocusable.focus(), 50);
                 }
            },

            closeModal: function(modalId) {
                const modal = document.getElementById(modalId);
                if (!modal || modal.style.display === 'none') {
                     return;
                 }

                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');

                 const anyModalOpen = Array.from(this.dom.appContainer?.querySelectorAll('.wheel-popup') || []).some(
                     m => m.style.display === 'block'
                 );

                 if (!anyModalOpen && this.dom.overlay) {
                     this.dom.overlay.style.display = 'none';
                 }

                 // Return focus logic (simplified)
                 if (this.dom.inputView?.style.display === 'block') {
                     const personalizeButton = document.getElementById('wheel-personalizeBtn');
                     const helpButton = this.dom.inputView.querySelector('button[onclick^="WheelApp.openModal(\'wheel-helpPopup\'"]');
                     if (modalId === 'wheel-personalizePopup' && personalizeButton) personalizeButton.focus();
                     else if (modalId === 'wheel-helpPopup' && helpButton) helpButton.focus();
                     else if (this.dom.nextBtn && !this.dom.nextBtn.disabled) this.dom.nextBtn.focus();
                     else if (this.dom.prevBtn && !this.dom.prevBtn.disabled) this.dom.prevBtn.focus();

                 } else if (this.dom.chartView?.style.display === 'block') {
                     const historyButton = this.dom.chartView.querySelector('button[onclick^="WheelApp.openModal(\'wheel-historyPopup\'"]');
                     const returnButton = this.dom.chartView.querySelector('button[onclick="WheelApp.showInputView()"]');
                     if (modalId === 'wheel-historyPopup' && historyButton) historyButton.focus();
                     else if (returnButton) returnButton.focus();
                 }
            },

            closeAllModals: function() {
                this.dom.appContainer?.querySelectorAll('.wheel-popup').forEach(modal => {
                    if (modal.style.display !== 'none') {
                        modal.style.display = 'none';
                        modal.setAttribute('aria-hidden', 'true');
                    }
                });
                if (this.dom.overlay && this.dom.overlay.style.display !== 'none') {
                    this.dom.overlay.style.display = 'none';
                }
            },

            // --- Note Popup
			
			            // --- Note Popup ---
            openNotePopup: function(pillarId, subPillarId) {
                const subPillar = this.findSubPillar(pillarId, subPillarId);
                if (!subPillar || !this.dom.notePopup || !this.dom.notePopupSubPillarName || !this.dom.notePopupTextarea || !this.dom.notePopupActionKeyCheckbox || !this.dom.saveNoteBtn) {
                    console.error("Impossible d'ouvrir la popup de note (WheelApp): élément(s) manquant(s) ou sous-pilier invalide.");
                    return;
                }

                this.dom.notePopupSubPillarName.textContent = subPillar.name;
                this.dom.notePopupTextarea.value = subPillar.note || '';
                this.dom.notePopupActionKeyCheckbox.checked = subPillar.isAction || false;

                // Store IDs for saving
                this.dom.saveNoteBtn.dataset.pillarId = pillarId;
                this.dom.saveNoteBtn.dataset.subPillarId = subPillarId;

                this.openModal('wheel-notePopup');
                this.dom.notePopupTextarea.focus();
            },

            saveNoteFromPopup: function() {
                if (!this.dom.saveNoteBtn || !this.dom.notePopupTextarea || !this.dom.notePopupActionKeyCheckbox) return;

                const pillarId = this.dom.saveNoteBtn.dataset.pillarId;
                const subPillarId = this.dom.saveNoteBtn.dataset.subPillarId;
                const noteText = this.dom.notePopupTextarea.value;
                const isAction = this.dom.notePopupActionKeyCheckbox.checked;

                if (pillarId && subPillarId) {
                    this.updateNote(pillarId, subPillarId, noteText, isAction);
                    this.showNotification("Note sauvegardée.");
                    this.closeModal('wheel-notePopup');
                } else {
                     console.error("Impossible de sauvegarder la note: IDs manquants (WheelApp).");
                     this.showNotification("Erreur lors de la sauvegarde de la note.");
                }
            },

            // --- Customization ---
            renderCustomizationForm: function() {
                if (!this.dom.customizationContent) return;
                this.dom.customizationContent.innerHTML = '';

                this.pillars.forEach((pillar, pIndex) => {
                    const pillarDiv = document.createElement('div');
                    pillarDiv.className = 'wheel-customization-section';
                    pillarDiv.innerHTML = `
                        <h4>Pilier: ${pillar.name} (Non modifiable)</h4>
                        <h5>Sous-Piliers:</h5>
                    `;

                    if (pillar.subPillars && pillar.subPillars.length > 0) {
                        pillar.subPillars.forEach((subPillar, spIndex) => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'wheel-customization-item';
                            itemDiv.innerHTML = `
                                <input type="text" value="${subPillar.name}" data-pillar-id="${pillar.id}" data-subpillar-id="${subPillar.id}" placeholder="Nom du sous-pilier" aria-label="Nom du sous-pilier ${subPillar.name} pour le pilier ${pillar.name}">
                                <!-- Suppression (future feature)
                                <button class="wheel-icon-button wheel-danger-button" onclick="WheelApp.deleteSubPillar('${pillar.id}', '${subPillar.id}')" aria-label="Supprimer le sous-pilier ${subPillar.name}">
                                    ${this.deleteIcon}
                                </button>
                                -->
                            `;
                            pillarDiv.appendChild(itemDiv);
                        });
                    } else {
                        pillarDiv.innerHTML += "<p>Aucun sous-pilier.</p>";
                    }
                    this.dom.customizationContent.appendChild(pillarDiv);
                });
                 this.dom.customizationContent.innerHTML += `<p style="font-size: 0.9em; color: var(--wheel-secondary-text-color);">La suppression/ajout de piliers/sous-piliers sera disponible ultérieurement.</p>`;
            },

            saveCustomization: function() {
                if (!this.dom.customizationContent) return;
                 let changed = false;
                const inputs = this.dom.customizationContent.querySelectorAll('input[type="text"][data-subpillar-id]');

                inputs.forEach(input => {
                    const pillarId = input.dataset.pillarId;
                    const subPillarId = input.dataset.subpillarId;
                    const newName = input.value.trim();

                    if (!pillarId || !subPillarId) return;

                    const subPillar = this.findSubPillar(pillarId, subPillarId);
                    if (subPillar && newName && subPillar.name !== newName) {
                        subPillar.name = newName;
                         changed = true;
                    } else if (subPillar && !newName) {
                         input.value = subPillar.name; // Restore original name if empty
                         this.showNotification(`Le nom du sous-pilier ne peut pas être vide (${subPillar.name}).`);
                     }
                });

                if (changed) {
                    this.saveData();
                    this.renderPillar(); // Re-render the current pillar view
                    this.showNotification("Personnalisation sauvegardée.");
                } else {
                     this.showNotification("Aucune modification détectée.");
                 }
                this.closeModal('wheel-customizationPopup');
            },

             // Placeholder for future delete functionality
             deleteSubPillar: function(pillarId, subPillarId) {
                 this.showNotification("Fonctionnalité de suppression non implémentée.");
                  /* // Actual logic would be:
                  if (!confirm(`Êtes-vous sûr de vouloir supprimer ce sous-pilier ? Cette action est irréversible.`)) return;
                  const pillar = this.pillars.find(p => p.id === pillarId);
                  if (pillar && pillar.subPillars) {
                      pillar.subPillars = pillar.subPillars.filter(sp => sp.id !== subPillarId);
                      this.saveData();
                      this.renderCustomizationForm(); // Re-render the form
                      this.renderPillar(); // Re-render the main view
                      this.showNotification("Sous-pilier supprimé.");
                  }
                  */
             },

            // --- Theme Management ---
            setupTheme: function() {
                if (!this.dom.themeCheckbox || !this.dom.appContainer) return;
                const savedTheme = localStorage.getItem('wheelOfLife_theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                let isDark = false;

                if (savedTheme) {
                    isDark = savedTheme === 'dark';
                } else {
                    isDark = prefersDark;
                }

                this.dom.themeCheckbox.checked = isDark;
                this.applyTheme(isDark);

                // Listen for system theme changes ONLY if no theme is explicitly saved
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (!localStorage.getItem('wheelOfLife_theme')) {
                        this.applyTheme(e.matches);
                        this.dom.themeCheckbox.checked = e.matches;
                         if (this.chartInstance) this.renderChart(); // Re-render chart on theme change
                    }
                });
            },

            toggleTheme: function() {
                if (!this.dom.themeCheckbox || !this.dom.appContainer) return;
                const isDark = this.dom.themeCheckbox.checked;
                this.applyTheme(isDark);
                localStorage.setItem('wheelOfLife_theme', isDark ? 'dark' : 'light');
                if (this.chartInstance) this.renderChart(); // Re-render chart on theme change
            },

            applyTheme: function(isDark) {
                 if (!this.dom.appContainer) return;
                 if (isDark) {
                     this.dom.appContainer.classList.add('dark-theme');
                     document.body.classList.add('dark-theme'); // Optional: For global body styling
                     document.body.classList.remove('light-theme');
                 } else {
                     this.dom.appContainer.classList.remove('dark-theme');
                     document.body.classList.remove('dark-theme');
                     document.body.classList.add('light-theme'); // Optional: For global body styling
                 }
            },

            // --- Event Listeners ---
            addEventListeners: function() {
                 // Theme Toggle
                if (this.dom.themeCheckbox) {
                    this.dom.themeCheckbox.addEventListener('change', () => this.toggleTheme());
                }

                 // Keyboard Navigation for Pillars
                document.addEventListener('keydown', (e) => {
                     // Ignore if focus is inside an input, textarea, or select
                     if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                         return;
                     }
                     // Ignore if a modal is open
                     if (this.dom.overlay && this.dom.overlay.style.display === 'flex') {
                         return;
                     }
                     // Ignore if not in input view
                      if (!this.dom.inputView || this.dom.inputView.style.display !== 'block') {
                          return;
                      }

                     if (e.key === 'ArrowLeft') {
                         this.changePillar(-1);
                         e.preventDefault();
                     } else if (e.key === 'ArrowRight') {
                         this.changePillar(1);
                         e.preventDefault();
                     }
                 });

                 // Keyboard Navigation for Sliders
                 this.dom.appContainer?.addEventListener('keydown', (e) => {
                     if (e.target.type === 'range' && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
                         const range = e.target;
                         const step = e.key === 'ArrowLeft' ? -1 : 1;
                         const newValue = Math.min(Math.max(parseInt(range.value) + step, 1), 10);
                         if (newValue !== parseInt(range.value)) {
                             range.value = newValue;
                             const event = new Event('input', { bubbles: true });
                             range.dispatchEvent(event);
                         }
                         e.preventDefault();
                     }
                 });

                // Long press for Premium (only if logo exists)
                if (this.dom.appLogo) {
                    this.dom.appLogo.addEventListener('mousedown', (e) => this.handleLogoPressStart(e));
                    this.dom.appLogo.addEventListener('touchstart', (e) => this.handleLogoPressStart(e), { passive: false });
                    this.dom.appLogo.addEventListener('mouseup', () => this.handleLogoPressEnd());
                    this.dom.appLogo.addEventListener('mouseleave', () => this.handleLogoPressEnd());
                    this.dom.appLogo.addEventListener('touchend', () => this.handleLogoPressEnd());
                    this.dom.appLogo.addEventListener('touchcancel', () => this.handleLogoPressEnd());
                }
            }
        }; // End of WheelApp

        // ========================================================================
        // == APP 2: Goals (Encapsulated & Prefixed) ============================
        // ========================================================================
        const GoalsApp = {
            pillarsData: [ // Matches WheelApp for consistency initially
                { id: "sante", name: "Santé", icon: "fa-heartbeat", color: "#FF6347", subPillars: [ { id: "sante-phy", name: "Physique", goals: []}, { id: "sante-men", name: "Mental", goals: [] }, { id: "sante-som", name: "Sommeil", goals: [] }, { id: "sante-nut", name: "Nutrition", goals: [] }, { id: "sante-ene", name: "Énergie", goals: [] } ] },
                { id: "famille", name: "Famille", icon: "fa-users", color: "#FFD700", subPillars: [ { id: "fam-pro", name: "Proches", goals: [] }, { id: "fam-com", name: "Communication", goals: [] }, { id: "fam-tmp", name: "Temps passé", goals: [] }, { id: "fam-sou", name: "Soutien", goals: [] }, { id: "fam-har", name: "Harmonie", goals: [] } ] },
                { id: "finances", name: "Finances", icon: "fa-coins", color: "#32CD32", subPillars: [ { id: "fin-0", name: "Revenus", goals: [] }, { id: "fin-1", name: "Épargne", goals: [] }, { id: "fin-2", name: "Dépenses", goals: [] }, { id: "fin-3", name: "Investissements", goals: [] }, { id: "fin-4", name: "Sécurité", goals: [] } ] },
                { id: "carriere", name: "Carrière", icon: "fa-briefcase", color: "#1E90FF", subPillars: [ { id: "car-0", name: "Satisfaction", goals: [] }, { id: "car-1", name: "Progression", goals: [] }, { id: "car-2", name: "Équilibre", goals: [] }, { id: "car-3", name: "Compétences", goals: [] }, { id: "car-4", name: "Reconnaissance", goals: [] } ] },
                { id: "loisirs", name: "Loisirs", icon: "fa-gamepad", color: "#FF69B4", subPillars: [ { id: "loi-0", name: "Temps libre", goals: [] }, { id: "loi-1", name: "Passions", goals: [] }, { id: "loi-2", name: "Détente", goals: [] }, { id: "loi-3", name: "Créativité", goals: [] }, { id: "loi-4", name: "Social", goals: [] } ] },
                { id: "devperso", name: "Développement perso", icon: "fa-brain", color: "#8A2BE2", subPillars: [ { id: "dev-0", name: "Apprentissage", goals: [] }, { id: "dev-1", name: "Objectifs", goals: [] }, { id: "dev-2", name: "Confiance", goals: [] }, { id: "dev-3", name: "Résilience", goals: [] }, { id: "dev-4", name: "Clarté", goals: [] } ] },
                { id: "relations", name: "Relations sociales", icon: "fa-user-friends", color: "#FF4500", subPillars: [ { id: "rel-0", name: "Amis", goals: [] }, { id: "rel-1", name: "Réseau", goals: [] }, { id: "rel-2", name: "Écoute", goals: [] }, { id: "rel-3", name: "Partage", goals: [] }, { id: "rel-4", name: "Qualité", goals: [] } ] },
                { id: "cadrevie", name: "Cadre de vie", icon: "fa-home", color: "#00CED1", subPillars: [ { id: "cad-0", name: "Logement", goals: [] }, { id: "cad-1", name: "Environnement", goals: [] }, { id: "cad-2", name: "Organisation", goals: [] }, { id: "cad-3", name: "Confort", goals: [] }, { id: "cad-4", name: "Esthétique", goals: [] } ] }
            ],
            currentPillarIndex: 0,
            editingTarget: null, // Pour la popup
            dom: {},

            init: function() {
                console.log("GoalsApp Initializing...");
                this.cacheDomElements();
                this.loadGoals();
                this.addEventListeners();
                // Initial view state: show welcome screen
                this.dom.welcomeScreen.style.display = 'block';
                this.dom.appContent.style.display = 'none';
                 // Set default theme to the first pillar's theme
                this.setTheme(this.pillarsData[this.currentPillarIndex].id);
                console.log("GoalsApp Initialized.");
            },

             cacheDomElements: function() {
                this.dom = {
                    appContainer: document.getElementById('app-goals'),
                    welcomeScreen: document.getElementById('goals-welcome-screen'),
                    startButton: document.getElementById('goals-start-button'),
                    appContent: document.getElementById('goals-app-content'),
                    pillarHeader: document.getElementById('goals-pillar-header'),
                    pillarTitle: document.getElementById('goals-pillar-title'),
                    pillarIcon: document.getElementById('goals-pillar-icon'),
                    pillarContent: document.getElementById('goals-pillar-content'),
                    prevButton: document.getElementById('goals-prev-button'),
                    nextButton: document.getElementById('goals-next-button'),
                    popup: document.getElementById('goals-popup'),
                    popupText: document.getElementById('goals-popup-text')
                };
            },

            addEventListeners: function() {
                 if(this.dom.startButton) this.dom.startButton.addEventListener('click', () => this.startApp());
                 if(this.dom.prevButton) this.dom.prevButton.addEventListener('click', () => this.navigate(-1));
                 if(this.dom.nextButton) this.dom.nextButton.addEventListener('click', () => this.navigate(1));
                 // Event delegation for handling clicks on goal inputs within the pillar content
                 if(this.dom.pillarContent) {
                     this.dom.pillarContent.addEventListener('click', (e) => {
                         if (e.target && e.target.matches('.goals-objectif input')) {
                             this.ouvrirPopup(e.target);
                         }
                     });
                 }
            },

             startApp: function() {
                 this.dom.welcomeScreen.style.display = 'none';
                 this.dom.appContent.style.display = 'block';
                 this.renderPillar(); // Render the first pillar
             },

             loadGoals: function() {
                 const savedGoals = localStorage.getItem('personalGoals_data');
                 if (savedGoals) {
                     try {
                         const loadedData = JSON.parse(savedGoals);
                         // Basic validation: check if it's an array and has the expected structure
                         if (Array.isArray(loadedData) && loadedData.every(p => p.id && p.name && Array.isArray(p.subPillars))) {
                            // Merge loaded goals into the default structure
                            this.pillarsData = this.pillarsData.map(defaultPillar => {
                                const loadedPillar = loadedData.find(lp => lp.id === defaultPillar.id);
                                if (loadedPillar) {
                                    defaultPillar.subPillars = defaultPillar.subPillars.map(defaultSubPillar => {
                                        const loadedSubPillar = loadedPillar.subPillars.find(lsp => lsp.id === defaultSubPillar.id);
                                        if (loadedSubPillar && Array.isArray(loadedSubPillar.goals)) {
                                            // Ensure goals are strings
                                            defaultSubPillar.goals = loadedSubPillar.goals.map(g => String(g));
                                        } else {
                                             defaultSubPillar.goals = []; // Keep default empty array if not found or invalid
                                        }
                                        return defaultSubPillar;
                                    });
                                }
                                return defaultPillar;
                            });
                            console.log("GoalsApp: Goals loaded successfully.");
                         } else {
                            console.warn("GoalsApp: Loaded data structure mismatch. Using defaults.");
                            this.initializeDefaultGoals();
                         }
                     } catch (e) {
                         console.error("GoalsApp: Error parsing saved goals. Using defaults.", e);
                         this.initializeDefaultGoals();
                     }
                 } else {
                      console.log("GoalsApp: No saved goals found. Using defaults.");
                      this.initializeDefaultGoals();
                 }
             },

             initializeDefaultGoals: function() {
                 // Ensure every subPillar has an empty goals array if none loaded
                 this.pillarsData.forEach(pillar => {
                     pillar.subPillars.forEach(subPillar => {
                         if (!Array.isArray(subPillar.goals)) {
                             subPillar.goals = [];
                         }
                     });
                 });
             },

             saveGoals: function() {
                 try {
                     localStorage.setItem('personalGoals_data', JSON.stringify(this.pillarsData));
                 } catch (e) {
                     console.error("GoalsApp: Failed to save goals.", e);
                     // Consider notifying the user if storage is full
                 }
             },

             renderPillar: function() {
                 const pillar = this.pillarsData[this.currentPillarIndex];
                 if (!pillar || !this.dom.pillarTitle || !this.dom.pillarIcon || !this.dom.pillarContent || !this.dom.appContainer) return;

                 this.dom.pillarTitle.textContent = pillar.name;
                 this.dom.pillarIcon.className = `fas ${pillar.icon}`; // Update icon class
                 this.setTheme(pillar.id);

                 let contentHTML = '';
                 pillar.subPillars.forEach(subPillar => {
                     contentHTML += `
                         <div class="goals-sous-pilier">
                             <h3>${subPillar.name}</h3>
                             <div class="goals-objectif">
                                 <span class="goals-objectif-label">Objectif 1:</span>
                                 <input type="text" value="${subPillar.goals[0] || ''}" placeholder="Cliquez pour définir..." data-pillar-id="${pillar.id}" data-subpillar-id="${subPillar.id}" data-goal-index="0" readonly>
                             </div>
                             <div class="goals-objectif">
                                 <span class="goals-objectif-label">Objectif 2:</span>
                                 <input type="text" value="${subPillar.goals[1] || ''}" placeholder="Cliquez pour définir..." data-pillar-id="${pillar.id}" data-subpillar-id="${subPillar.id}" data-goal-index="1" readonly>
                             </div>
                             <div class="goals-objectif">
                                 <span class="goals-objectif-label">Objectif 3:</span>
                                 <input type="text" value="${subPillar.goals[2] || ''}" placeholder="Cliquez pour définir..." data-pillar-id="${pillar.id}" data-subpillar-id="${subPillar.id}" data-goal-index="2" readonly>
                             </div>
                         </div>`;
                 });

                 this.dom.pillarContent.innerHTML = contentHTML;
                 this.updateNavButtons();
             },

             setTheme: function(pillarId) {
                 if (this.dom.appContainer) {
                     this.dom.appContainer.dataset.theme = pillarId;
                 }
             },

             navigate: function(direction) {
                 const newIndex = this.currentPillarIndex + direction;
                 if (newIndex >= 0 && newIndex < this.pillarsData.length) {
                     this.currentPillarIndex = newIndex;
                     this.renderPillar();
                 }
             },

             updateNavButtons: function() {
                 if(this.dom.prevButton) this.dom.prevButton.disabled = (this.currentPillarIndex === 0);
                 if(this.dom.nextButton) this.dom.nextButton.disabled = (this.currentPillarIndex === this.pillarsData.length - 1);
             },

             // --- Popup Logic ---
             ouvrirPopup: function(targetInput) {
                 if (!this.dom.popup || !this.dom.popupText) return;
                 this.editingTarget = targetInput;
                 this.dom.popupText.value = targetInput.value;
                 this.dom.popup.style.display = 'block';
                 this.dom.popupText.focus();
             },

             fermerPopup: function() {
                 if (!this.dom.popup) return;
                 this.dom.popup.style.display = 'none';
                 this.editingTarget = null;
             },

             modifierObjectif: function() {
                 if (!this.editingTarget || !this.dom.popupText) return;

                 const pillarId = this.editingTarget.dataset.pillarId;
                 const subPillarId = this.editingTarget.dataset.subpillarId;
                 const goalIndex = parseInt(this.editingTarget.dataset.goalIndex, 10);
                 const newGoalText = this.dom.popupText.value.trim();

                 const pillar = this.pillarsData.find(p => p.id === pillarId);
                 if (pillar) {
                     const subPillar = pillar.subPillars.find(sp => sp.id === subPillarId);
                     if (subPillar && !isNaN(goalIndex)) {
                         // Ensure the goals array exists and has enough space
                         while (subPillar.goals.length <= goalIndex) {
                            subPillar.goals.push('');
                         }
                         subPillar.goals[goalIndex] = newGoalText;
                         this.editingTarget.value = newGoalText; // Update the input field visually
                         this.saveGoals();
                         this.fermerPopup();
                         console.log(`GoalsApp: Goal updated for ${pillar.name} > ${subPillar.name} [${goalIndex}]`);
                     }
                 }
             },

             supprimerObjectif: function() {
                 if (!this.editingTarget) return;
                 // Set goal to empty string instead of actually removing array element
                  const pillarId = this.editingTarget.dataset.pillarId;
                  const subPillarId = this.editingTarget.dataset.subpillarId;
                  const goalIndex = parseInt(this.editingTarget.dataset.goalIndex, 10);

                  const pillar = this.pillarsData.find(p => p.id === pillarId);
                  if (pillar) {
                      const subPillar = pillar.subPillars.find(sp => sp.id === subPillarId);
                      if (subPillar && !isNaN(goalIndex) && subPillar.goals.length > goalIndex) {
                          subPillar.goals[goalIndex] = ''; // Set to empty string
                          this.editingTarget.value = ''; // Update the input field visually
                          this.saveGoals();
                          this.fermerPopup();
                          console.log(`GoalsApp: Goal cleared for ${pillar.name} > ${subPillar.name} [${goalIndex}]`);
                      } else {
                          this.fermerPopup(); // Close even if nothing to clear
                      }
                  } else {
                      this.fermerPopup();
                  }
             }
        }; // End of GoalsApp

        // ========================================================================
        // == APP 3: Rituals (Encapsulated & Prefixed) ==========================
        // ========================================================================
        const RitualsApp = {
            // --- State & Data ---
            rituals: [], // Array of { id, name, category ('morning', 'afternoon', 'evening'), icon, active }
            history: {}, // Object like { 'YYYY-MM-DD': { ritualId: completed (true/false), reflection: "..." } }
            settings: {
                morningCutoff: '12:00',
                afternoonCutoff: '18:00',
                eveningCutoff: '23:59', // Represents end of day for evening rituals
            },
            currentView: 'today', // 'today', 'history', 'stats', 'settings'
            currentDate: new Date(), // Date being viewed/edited
            selectedHistoryDate: null, // Date selected in history view
            confirmationCallback: null, // Function to call on confirm modal

            // --- DOM References ---
            dom: {},

            // --- Initialization ---
            init: function() {
                console.log("RitualsApp Initializing...");
                this.cacheDomElements();
                this.loadData();
                this.addEventListeners();
                this.updateDateDisplay();
                this.updateStreakCount();
                this.switchToView('today'); // Start on Today view
                console.log("RitualsApp Initialized.");
            },

            cacheDomElements: function() {
                this.dom = {
                    // Main elements
                    appContainer: document.getElementById('app-rituals'),
                    currentDateDisplay: document.getElementById('rituals-current-date'),
                    streakCountDisplay: document.getElementById('rituals-streak-count'),
                    // Tabs
                    todayTab: document.getElementById('rituals-today-tab'),
                    historyTab: document.getElementById('rituals-history-tab'),
                    statsTab: document.getElementById('rituals-stats-tab'),
                    settingsTab: document.getElementById('rituals-settings-tab'),
                    // Tab Content Containers
                    todayContent: document.getElementById('rituals-today-content'),
                    historyContent: document.getElementById('rituals-history-content'),
                    statsContent: document.getElementById('rituals-stats-content'),
                    settingsContent: document.getElementById('rituals-settings-content'),
                    // Today View
                    dailyProgress: document.getElementById('rituals-daily-progress'),
                    progressPercentage: document.getElementById('rituals-progress-percentage'),
                    completedCount: document.getElementById('rituals-completed-count'),
                    totalCount: document.getElementById('rituals-total-count'),
                    morningRituals: document.getElementById('rituals-morning-rituals'),
                    afternoonRituals: document.getElementById('rituals-afternoon-rituals'),
                    eveningRituals: document.getElementById('rituals-evening-rituals'),
                    morningProgress: document.getElementById('rituals-morning-progress'),
                    afternoonProgress: document.getElementById('rituals-afternoon-progress'),
                    eveningProgress: document.getElementById('rituals-evening-progress'),
                    dailyReflection: document.getElementById('rituals-daily-reflection'),
                    saveReflectionBtn: document.getElementById('rituals-save-reflection'),
                    // History View
                    historyFilter: document.getElementById('rituals-history-filter'),
                    exportHistoryBtn: document.getElementById('rituals-export-history'),
                    historyList: document.getElementById('rituals-history-list'),
                    // Stats View
                    currentStreak: document.getElementById('rituals-current-streak'),
                    successRate: document.getElementById('rituals-success-rate'),
                    favoriteRitual: document.getElementById('rituals-favorite-ritual'),
                    weeklyChartCanvas: document.getElementById('rituals-weekly-chart'),
                    ritualDistributionChartCanvas: document.getElementById('rituals-ritual-distribution-chart'),
                    // Settings View
                    addRitualBtn: document.getElementById('rituals-add-ritual-btn'),
                    availableRituals: document.getElementById('rituals-available-rituals'),
                    morningCutoff: document.getElementById('rituals-morning-cutoff'),
                    afternoonCutoff: document.getElementById('rituals-afternoon-cutoff'),
                    eveningCutoff: document.getElementById('rituals-evening-cutoff'),
                    resetDataBtn: document.getElementById('rituals-reset-data'),
                    importDataBtn: document.getElementById('rituals-import-data'),
                    // Modals
                    addRitualModal: document.getElementById('rituals-add-ritual-modal'),
                    ritualNameInput: document.getElementById('rituals-ritual-name'),
                    ritualCategorySelect: document.getElementById('rituals-ritual-category'),
                    ritualIconSelect: document.getElementById('rituals-ritual-icon'),
                    cancelAddRitualBtn: document.getElementById('rituals-cancel-add-ritual'),
                    confirmAddRitualBtn: document.getElementById('rituals-confirm-add-ritual'),
                    exportModal: document.getElementById('rituals-export-modal'),
                    exportDataTextarea: document.getElementById('rituals-export-data'),
                    aiPromptTextarea: document.getElementById('rituals-ai-prompt'),
                    copyExportBtn: document.getElementById('rituals-copy-export'),
                    closeExportBtn: document.getElementById('rituals-close-export'),
                    submitToAIBtn: document.getElementById('rituals-submit-to-ai'),
                    confirmationModal: document.getElementById('rituals-confirmation-modal'),
                    confirmationTitle: document.getElementById('rituals-confirmation-title'),
                    confirmationMessage: document.getElementById('rituals-confirmation-message'),
                    cancelConfirmBtn: document.getElementById('rituals-cancel-confirm'),
                    confirmActionBtn: document.getElementById('rituals-confirm-action'),
                };
            },

            addEventListeners: function() {
                // Tab Navigation
                this.dom.todayTab?.addEventListener('click', () => this.switchToView('today'));
                this.dom.historyTab?.addEventListener('click', () => this.switchToView('history'));
                this.dom.statsTab?.addEventListener('click', () => this.switchToView('stats'));
                this.dom.settingsTab?.addEventListener('click', () => this.switchToView('settings'));

                // Today View Actions
                this.dom.todayContent?.addEventListener('change', (e) => {
                    if (e.target.matches('.rituals-checkbox')) {
                        this.toggleRitualCompletion(e.target.dataset.ritualId, e.target.checked);
                    }
                });
                 this.dom.saveReflectionBtn?.addEventListener('click', () => this.saveReflection());

                 // History View Actions
                 this.dom.historyFilter?.addEventListener('change', () => this.renderHistoryView());
                 this.dom.exportHistoryBtn?.addEventListener('click', () => this.openExportModal());

                 // Settings View Actions
                 this.dom.addRitualBtn?.addEventListener('click', () => this.openAddRitualModal());
                 this.dom.availableRituals?.addEventListener('change', (e) => {
                     if (e.target.matches('.rituals-toggle-switch input')) {
                         this.toggleRitualActive(e.target.dataset.ritualId, e.target.checked);
                     }
                 });
                 this.dom.availableRituals?.addEventListener('click', (e) => {
                     if (e.target.closest('.rituals-delete-btn')) {
                         const button = e.target.closest('.rituals-delete-btn');
                         this.confirmDeleteRitual(button.dataset.ritualId);
                     }
                 });
                 this.dom.morningCutoff?.addEventListener('change', (e) => this.updateSetting('morningCutoff', e.target.value));
                 this.dom.afternoonCutoff?.addEventListener('change', (e) => this.updateSetting('afternoonCutoff', e.target.value));
                 this.dom.eveningCutoff?.addEventListener('change', (e) => this.updateSetting('eveningCutoff', e.target.value));
                 this.dom.resetDataBtn?.addEventListener('click', () => this.confirmResetData());
                 // this.dom.importDataBtn?.addEventListener('click', () => this.importData()); // Import needs file input handler

                // Modal Buttons
                this.dom.cancelAddRitualBtn?.addEventListener('click', () => this.closeModal('rituals-add-ritual-modal'));
                this.dom.confirmAddRitualBtn?.addEventListener('click', () => this.addNewRitual());
                this.dom.copyExportBtn?.addEventListener('click', () => this.copyExportData());
                this.dom.closeExportBtn?.addEventListener('click', () => this.closeModal('rituals-export-modal'));
                this.dom.submitToAIBtn?.addEventListener('click', () => this.submitToAI());
                this.dom.cancelConfirmBtn?.addEventListener('click', () => this.closeModal('rituals-confirmation-modal'));
                this.dom.confirmActionBtn?.addEventListener('click', () => this.executeConfirmation());

                 // Close modals on overlay click (optional)
                 this.dom.addRitualModal?.addEventListener('click', (e) => { if (e.target === this.dom.addRitualModal) this.closeModal('rituals-add-ritual-modal'); });
                 this.dom.exportModal?.addEventListener('click', (e) => { if (e.target === this.dom.exportModal) this.closeModal('rituals-export-modal'); });
                 this.dom.confirmationModal?.addEventListener('click', (e) => { if (e.target === this.dom.confirmationModal) this.closeModal('rituals-confirmation-modal'); });
            },

            // --- Data Management ---
            loadData: function() {
                const savedRituals = localStorage.getItem('dailyRituals_rituals');
                const savedHistory = localStorage.getItem('dailyRituals_history');
                const savedSettings = localStorage.getItem('dailyRituals_settings');

                this.rituals = savedRituals ? JSON.parse(savedRituals) : this.getDefaultRituals();
                this.history = savedHistory ? JSON.parse(savedHistory) : {};
                this.settings = savedSettings ? { ...this.settings, ...JSON.parse(savedSettings) } : this.settings;

                // Ensure history keys are valid dates and structure is correct
                 this.cleanHistory();
            },

            saveData: function() {
                 try {
                     localStorage.setItem('dailyRituals_rituals', JSON.stringify(this.rituals));
                     localStorage.setItem('dailyRituals_history', JSON.stringify(this.history));
                     localStorage.setItem('dailyRituals_settings', JSON.stringify(this.settings));
                 } catch (e) {
                     console.error("RitualsApp: Failed to save data.", e);
                     // Consider notifying user
                 }
            },

             cleanHistory: function() {
                const cleanedHistory = {};
                for (const dateKey in this.history) {
                    if (this.isValidDateKey(dateKey) && typeof this.history[dateKey] === 'object' && this.history[dateKey] !== null) {
                        cleanedHistory[dateKey] = {};
                        // Ensure only known ritual IDs and boolean completion states are stored
                        for (const ritualId in this.history[dateKey]) {
                            if (this.rituals.some(r => r.id === ritualId) && typeof this.history[dateKey][ritualId] === 'boolean') {
                                cleanedHistory[dateKey][ritualId] = this.history[dateKey][ritualId];
                            } else if (ritualId === 'reflection' && typeof this.history[dateKey][ritualId] === 'string') {
                                cleanedHistory[dateKey].reflection = this.history[dateKey].reflection;
                            }
                        }
                        // Ensure reflection exists, even if empty
                         if(cleanedHistory[dateKey].reflection === undefined) {
                             cleanedHistory[dateKey].reflection = "";
                         }
                    }
                }
                this.history = cleanedHistory;
             },

            getDefaultRituals: function() {
                // Provide some sensible defaults
                return [
                    { id: 'ritual-1', name: 'Boire un verre d\'eau', category: 'morning', icon: 'water', active: true },
                    { id: 'ritual-2', name: 'Méditation 5 min', category: 'morning', icon: 'meditation', active: true },
                    { id: 'ritual-3', name: 'Planifier la journée', category: 'morning', icon: 'list', active: true },
                    { id: 'ritual-4', name: 'Pause active (marche)', category: 'afternoon', icon: 'walking', active: true },
                    { id: 'ritual-5', name: 'Revue de la journée', category: 'evening', icon: 'journal', active: true },
                    { id: 'ritual-6', name: 'Lecture 15 min', category: 'evening', icon: 'book', active: true },
                ];
            },

             getDateKey: function(date = this.currentDate) {
                 // Format: YYYY-MM-DD
                 const year = date.getFullYear();
                 const month = String(date.getMonth() + 1).padStart(2, '0');
                 const day = String(date.getDate()).padStart(2, '0');
                 return `${year}-${month}-${day}`;
             },

             isValidDateKey: function(key) {
                 return /^\d{4}-\d{2}-\d{2}$/.test(key);
             },

            // --- View Switching & Rendering ---
            switchToView: function(viewName) {
                this.currentView = viewName;

                // Hide all content panels
                this.dom.todayContent?.classList.add('hidden');
                this.dom.historyContent?.classList.add('hidden');
                this.dom.statsContent?.classList.add('hidden');
                this.dom.settingsContent?.classList.add('hidden');

                // Deactivate all tabs
                this.dom.todayTab?.classList.remove('text-indigo-600', 'border-indigo-600');
                this.dom.todayTab?.classList.add('text-gray-500');
                this.dom.historyTab?.classList.remove('text-indigo-600', 'border-indigo-600');
                this.dom.historyTab?.classList.add('text-gray-500');
                this.dom.statsTab?.classList.remove('text-indigo-600', 'border-indigo-600');
                this.dom.statsTab?.classList.add('text-gray-500');
                this.dom.settingsTab?.classList.remove('text-indigo-600', 'border-indigo-600');
                this.dom.settingsTab?.classList.add('text-gray-500');

                // Show and activate the selected view/tab
                switch(viewName) {
                    case 'today':
                        this.dom.todayContent?.classList.remove('hidden');
                        this.dom.todayTab?.classList.add('text-indigo-600', 'border-indigo-600');
                        this.dom.todayTab?.classList.remove('text-gray-500');
                        this.renderTodayView();
                        break;
                    case 'history':
                        this.dom.historyContent?.classList.remove('hidden');
                        this.dom.historyTab?.classList.add('text-indigo-600', 'border-indigo-600');
                        this.dom.historyTab?.classList.remove('text-gray-500');
                        this.renderHistoryView();
                        break;
                    case 'stats':
                        this.dom.statsContent?.classList.remove('hidden');
                        this.dom.statsTab?.classList.add('text-indigo-600', 'border-indigo-600');
                        this.dom.statsTab?.classList.remove('text-gray-500');
                        this.renderStatsView();
                        break;
                    case 'settings':
                        this.dom.settingsContent?.classList.remove('hidden');
                        this.dom.settingsTab?.classList.add('text-indigo-600', 'border-indigo-600');
                        this.dom.settingsTab?.classList.remove('text-gray-500');
                        this.renderSettingsView();
                        break;
                }
            },

            renderTodayView: function() {
                 const dateKey = this.getDateKey();
                 const todaysHistory = this.history[dateKey] || {};
                 const activeRituals = this.rituals.filter(r => r.active);

                 let morningHTML = '', afternoonHTML = '', eveningHTML = '';
                 let morningCompleted = 0, afternoonCompleted = 0, eveningCompleted = 0;
                 let morningTotal = 0, afternoonTotal = 0, eveningTotal = 0;

                 activeRituals.forEach(ritual => {
                     const isCompleted = !!todaysHistory[ritual.id];
                     const ritualHTML = this.createRitualHTML(ritual, isCompleted);

                     switch(ritual.category) {
                         case 'morning':
                             morningHTML += ritualHTML;
                             morningTotal++;
                             if(isCompleted) morningCompleted++;
                             break;
                         case 'afternoon':
                             afternoonHTML += ritualHTML;
                             afternoonTotal++;
                             if(isCompleted) afternoonCompleted++;
                             break;
                         case 'evening':
                             eveningHTML += ritualHTML;
                             eveningTotal++;
                             if(isCompleted) eveningCompleted++;
                             break;
                     }
                 });

                 if(this.dom.morningRituals) this.dom.morningRituals.innerHTML = morningHTML || '<p class="text-sm text-gray-500">Aucun rituel pour le matin.</p>';
                 if(this.dom.afternoonRituals) this.dom.afternoonRituals.innerHTML = afternoonHTML || '<p class="text-sm text-gray-500">Aucun rituel pour l\'après-midi.</p>';
                 if(this.dom.eveningRituals) this.dom.eveningRituals.innerHTML = eveningHTML || '<p class="text-sm text-gray-500">Aucun rituel pour le soir.</p>';

                 // Update progress counters
                 if(this.dom.morningProgress) this.dom.morningProgress.textContent = `${morningCompleted}/${morningTotal}`;
                 if(this.dom.afternoonProgress) this.dom.afternoonProgress.textContent = `${afternoonCompleted}/${afternoonTotal}`;
                 if(this.dom.eveningProgress) this.dom.eveningProgress.textContent = `${eveningCompleted}/${eveningTotal}`;

                 // Update overall progress
                 const totalCompleted = morningCompleted + afternoonCompleted + eveningCompleted;
                 const totalActive = activeRituals.length;
                 const percentage = totalActive > 0 ? Math.round((totalCompleted / totalActive) * 100) : 0;

                 if(this.dom.dailyProgress) this.dom.dailyProgress.style.width = `${percentage}%`;
                 if(this.dom.progressPercentage) this.dom.progressPercentage.textContent = `${percentage}%`;
                 if(this.dom.completedCount) this.dom.completedCount.textContent = `${totalCompleted} complétés`;
                 if(this.dom.totalCount) this.dom.totalCount.textContent = `${totalActive} total`;

                 // Load reflection
                 if(this.dom.dailyReflection) this.dom.dailyReflection.value = todaysHistory.reflection || '';
            },

             createRitualHTML: function(ritual, isCompleted) {
                // Map icon keys to Font Awesome classes or emojis
                 const iconMap = {
                     sun: 'fas fa-sun', coffee: 'fas fa-coffee', water: 'fas fa-tint', meditation: 'fas fa-om', book: 'fas fa-book-open', exercise: 'fas fa-dumbbell', journal: 'fas fa-pencil-alt', moon: 'fas fa-moon', list: 'fas fa-list-alt', utensils: 'fas fa-utensils', walking: 'fas fa-walking', bullseye: 'fas fa-bullseye', 'mobile-screen': 'fas fa-mobile-alt', spa: 'fas fa-spa', 'book-open': 'fas fa-book-reader', heart: 'fas fa-heart'
                 };
                 const iconClass = iconMap[ritual.icon] || 'fas fa-check'; // Default icon

                 return `
                     <div class="flex items-center justify-between bg-white p-3 rounded-md shadow-sm">
                         <div class="flex items-center">
                             <i class="${iconClass} text-lg mr-3 ${isCompleted ? 'text-indigo-500' : 'text-gray-400'}"></i>
                             <span class="text-gray-800 ${isCompleted ? 'line-through text-gray-500' : ''}">${ritual.name}</span>
                         </div>
                         <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="rituals-checkbox sr-only peer" data-ritual-id="${ritual.id}" ${isCompleted ? 'checked' : ''}>
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                         </label>
                     </div>
                 `;
            },

            renderHistoryView: function() {
                 if (!this.dom.historyList) return;
                 this.dom.historyList.innerHTML = ''; // Clear previous list

                 const filterValue = this.dom.historyFilter?.value || 'all';
                 const sortedDates = Object.keys(this.history).sort((a, b) => b.localeCompare(a)); // Newest first

                 let displayedCount = 0;
                 sortedDates.forEach(dateKey => {
                     const dayHistory = this.history[dateKey];
                     const entryDiv = document.createElement('div');
                     entryDiv.className = 'p-4 border-b border-gray-200';

                     const date = new Date(dateKey + 'T00:00:00'); // Ensure correct date parsing
                     const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                     let ritualsHTML = '<ul class="list-disc list-inside mt-2 space-y-1 text-sm">';
                     let completedCount = 0;
                     let totalCount = 0;
                     let shouldDisplay = false;

                     this.rituals.forEach(ritual => {
                         if (!ritual.active) return; // Only show history for rituals that were active at some point (or are currently)
                         totalCount++;
                         const completed = !!dayHistory[ritual.id];
                         if(completed) completedCount++;

                         const displayRitual = (filterValue === 'all') ||
                                               (filterValue === 'completed' && completed) ||
                                               (filterValue === 'missed' && !completed);

                         if(displayRitual) {
                             ritualsHTML += `<li class="${completed ? 'text-green-600' : 'text-red-600'}"><i class="fas ${completed ? 'fa-check-circle' : 'fa-times-circle'} mr-1"></i> ${ritual.name}</li>`;
                             shouldDisplay = true; // Mark this date entry for display
                         }
                     });
                     ritualsHTML += '</ul>';

                     if (shouldDisplay || filterValue === 'all') { // Always display if filter is 'all'
                         entryDiv.innerHTML = `
                             <div class="flex justify-between items-center">
                                 <h4 class="font-semibold text-gray-700">${formattedDate}</h4>
                                 <span class="text-sm font-medium ${completedCount === totalCount && totalCount > 0 ? 'text-green-600' : 'text-gray-600'}">${completedCount}/${totalCount} complétés</span>
                             </div>
                             ${ritualsHTML}
                             ${dayHistory.reflection ? `<p class="mt-2 text-sm text-gray-600 italic border-l-2 border-gray-200 pl-2">"${dayHistory.reflection}"</p>` : ''}
                         `;
                         this.dom.historyList.appendChild(entryDiv);
                         displayedCount++;
                     }
                 });

                 if (displayedCount === 0) {
                     this.dom.historyList.innerHTML = '<p class="text-center text-gray-500 py-4">Aucun historique trouvé pour ce filtre.</p>';
                 }
            },

            renderStatsView: function() {
                if (!this.dom.statsContent) return;
                 const { streak, successRate, favoriteRitualId } = this.calculateStats();
                 const favoriteRitualName = this.rituals.find(r => r.id === favoriteRitualId)?.name || '-';

                 if(this.dom.currentStreak) this.dom.currentStreak.textContent = `${streak} jours`;
                 if(this.dom.successRate) this.dom.successRate.textContent = `${successRate.toFixed(0)}%`;
                 if(this.dom.favoriteRitual) this.dom.favoriteRitual.textContent = favoriteRitualName;

                 // Render charts (using Chart.js)
                 this.renderWeeklyChart();
                 this.renderRitualDistributionChart();
            },

            renderSettingsView: function() {
                if (!this.dom.availableRituals) return;
                this.dom.availableRituals.innerHTML = ''; // Clear existing

                 // Populate cutoff times
                 if(this.dom.morningCutoff) this.dom.morningCutoff.value = this.settings.morningCutoff;
                 if(this.dom.afternoonCutoff) this.dom.afternoonCutoff.value = this.settings.afternoonCutoff;
                 if(this.dom.eveningCutoff) this.dom.eveningCutoff.value = this.settings.eveningCutoff;

                 // Populate ritual list
                 this.rituals.forEach(ritual => {
                     const div = document.createElement('div');
                     div.className = 'flex items-center justify-between p-3 bg-white rounded-lg shadow-sm';
                     div.innerHTML = `
                         <div class="flex items-center">
                             <i class="${this.getIconClass(ritual.icon)} text-lg mr-3 text-gray-600"></i>
                             <span class="text-gray-800">${ritual.name} (${ritual.category})</span>
                         </div>
                         <div class="flex items-center space-x-3">
                             <label class="rituals-toggle-switch inline-flex items-center cursor-pointer">
                                 <input type="checkbox" class="sr-only peer" data-ritual-id="${ritual.id}" ${ritual.active ? 'checked' : ''}>
                                 <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                             </label>
                             <button class="rituals-delete-btn text-red-500 hover:text-red-700" data-ritual-id="${ritual.id}" aria-label="Supprimer ${ritual.name}">
                                 <i class="fas fa-trash-alt"></i>
                             </button>
                         </div>
                     `;
                     this.dom.availableRituals.appendChild(div);
                 });
            },

            // --- Actions ---
            toggleRitualCompletion: function(ritualId, completed) {
                const dateKey = this.getDateKey();
                if (!this.history[dateKey]) {
                    this.history[dateKey] = { reflection: "" };
                }
                this.history[dateKey][ritualId] = completed;
                this.saveData();
                this.renderTodayView(); // Update UI immediately
                 this.updateStreakCount(); // Update streak display
            },

            saveReflection: function() {
                 if (!this.dom.dailyReflection) return;
                 const dateKey = this.getDateKey();
                 if (!this.history[dateKey]) {
                     this.history[dateKey] = {};
                 }
                 this.history[dateKey].reflection = this.dom.dailyReflection.value.trim();
                 this.saveData();
                  this.showNotification("Réflexion enregistrée.");
            },

            addNewRitual: function() {
                if (!this.dom.ritualNameInput || !this.dom.ritualCategorySelect || !this.dom.ritualIconSelect) return;
                const name = this.dom.ritualNameInput.value.trim();
                const category = this.dom.ritualCategorySelect.value;
                const icon = this.dom.ritualIconSelect.value;

                if (!name) {
                    this.showNotification("Le nom du rituel est requis.", 'error');
                    return;
                }

                const newRitual = {
                    id: `ritual-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                    name: name,
                    category: category,
                    icon: icon,
                    active: true // Activate by default
                };

                this.rituals.push(newRitual);
                this.saveData();
                this.renderSettingsView(); // Update the settings list
                this.closeModal('rituals-add-ritual-modal');
                 this.showNotification(`Rituel "${name}" ajouté.`);
                 this.dom.ritualNameInput.value = ''; // Clear input
            },

             toggleRitualActive: function(ritualId, isActive) {
                 const ritual = this.rituals.find(r => r.id === ritualId);
                 if (ritual) {
                     ritual.active = isActive;
                     this.saveData();
                     this.renderTodayView(); // Update today view if active status changes
                     this.showNotification(`Rituel "${ritual.name}" ${isActive ? 'activé' : 'désactivé'}.`);
                 }
             },

             confirmDeleteRitual: function(ritualId) {
                 const ritual = this.rituals.find(r => r.id === ritualId);
                 if (!ritual) return;
                 this.confirmationCallback = () => this.deleteRitual(ritualId);
                 this.openConfirmationModal('Supprimer le rituel', `Êtes-vous sûr de vouloir supprimer le rituel "${ritual.name}" ? L'historique associé sera conservé mais il ne sera plus modifiable.`);
             },

            deleteRitual: function(ritualId) {
                const ritualName = this.rituals.find(r => r.id === ritualId)?.name || 'ce rituel';
                this.rituals = this.rituals.filter(r => r.id !== ritualId);
                 // Note: We keep the history associated with this ID, but it won't appear in new entries.
                this.saveData();
                this.renderSettingsView(); // Update the list
                 this.renderTodayView(); // Update main view
                 this.showNotification(`Rituel "${ritualName}" supprimé.`);
            },

             updateSetting: function(settingKey, value) {
                 if (this.settings.hasOwnProperty(settingKey)) {
                     this.settings[settingKey] = value;
                     this.saveData();
                     // Potentially re-render parts of the UI if needed, e.g., if cutoffs change categorization logic
                     this.showNotification(`Paramètre ${settingKey} mis à jour.`);
                 }
             },

             confirmResetData: function() {
                 this.confirmationCallback = this.resetData;
                 this.openConfirmationModal('Réinitialiser les données', 'ATTENTION : Ceci supprimera TOUS vos rituels personnalisés et TOUT votre historique. Cette action est IRRÉVERSIBLE. Continuer ?', true);
             },

             resetData: function() {
                 this.rituals = this.getDefaultRituals();
                 this.history = {};
                 // Keep settings unless explicitly requested otherwise
                 this.saveData();
                 this.switchToView('today'); // Go back to today view
                  this.showNotification("Données des rituels réinitialisées.");
             },

            // --- Stats Calculation ---
             calculateStats: function() {
                 let streak = 0;
                 let totalDays = 0;
                 let totalCompleted = 0;
                 let totalPossible = 0;
                 const ritualCompletionCounts = {};

                 const today = new Date();
                 let currentDate = new Date(today);
                 let consecutive = true;

                 // Calculate streak
                 while (consecutive) {
                     const dateKey = this.getDateKey(currentDate);
                     const dayHistory = this.history[dateKey];
                     let allCompleted = true;
                     let hasActiveRituals = false;

                     const activeRitualsToday = this.rituals.filter(r => r.active); // Check currently active
                      if(activeRitualsToday.length === 0) {
                         consecutive = false; // No active rituals, streak ends
                         break;
                      }

                      hasActiveRituals = true;
                      if (!dayHistory) { // If no entry for the day, streak broken
                          allCompleted = false;
                      } else {
                         allCompleted = activeRitualsToday.every(ritual => dayHistory[ritual.id]);
                      }

                     if (hasActiveRituals && allCompleted) {
                         streak++;
                         currentDate.setDate(currentDate.getDate() - 1); // Go to previous day
                     } else {
                         consecutive = false;
                     }
                 }

                 // Calculate success rate and favorite ritual
                 this.rituals.forEach(r => { ritualCompletionCounts[r.id] = 0; });

                 for (const dateKey in this.history) {
                     totalDays++;
                     const dayHistory = this.history[dateKey];
                     this.rituals.forEach(ritual => {
                         if (ritual.active) { // Only count active rituals for rate
                             totalPossible++;
                             if (dayHistory[ritual.id]) {
                                 totalCompleted++;
                                 ritualCompletionCounts[ritual.id]++;
                             }
                         }
                     });
                 }

                 const successRate = totalPossible > 0 ? (totalCompleted / totalPossible) * 100 : 0;

                 let favoriteRitualId = null;
                 let maxCompletions = -1;
                 for (const ritualId in ritualCompletionCounts) {
                     if (ritualCompletionCounts[ritualId] > maxCompletions) {
                         maxCompletions = ritualCompletionCounts[ritualId];
                         favoriteRitualId = ritualId;
                     }
                 }

                 return { streak, successRate, favoriteRitualId };
             },

             getWeeklyCompletionData: function() {
                 const labels = [];
                 const data = [];
                 const today = new Date();

                 for (let i = 6; i >= 0; i--) {
                     const date = new Date(today);
                     date.setDate(today.getDate() - i);
                     const dateKey = this.getDateKey(date);
                     labels.push(date.toLocaleDateString('fr-FR', { weekday: 'short' }));

                     const dayHistory = this.history[dateKey];
                     const activeRituals = this.rituals.filter(r => r.active);
                     let completedCount = 0;
                     if (dayHistory && activeRituals.length > 0) {
                         completedCount = activeRituals.filter(r => dayHistory[r.id]).length;
                         data.push(Math.round((completedCount / activeRituals.length) * 100));
                     } else if (activeRituals.length > 0) {
                         data.push(0); // Day exists, but no entry or no completion
                     } else {
                         data.push(0); // No active rituals for the day
                     }
                 }
                 return { labels, data };
             },

             getRitualDistributionData: function() {
                 const labels = [];
                 const data = [];
                 const colors = [];
                 const colorMap = { morning: '#f9d423', afternoon: '#4facfe', evening: '#a18cd1' };

                 this.rituals.forEach(ritual => {
                     if (ritual.active) {
                         labels.push(ritual.name);
                         data.push(1); // Simple count, could be completion rate later
                         colors.push(colorMap[ritual.category] || '#cccccc');
                     }
                 });
                 return { labels, data, colors };
             },

            // --- Chart Rendering ---
            renderWeeklyChart: function() {
                const ctx = this.dom.weeklyChartCanvas?.getContext('2d');
                if (!ctx || typeof Chart === 'undefined') return;

                const { labels, data } = this.getWeeklyCompletionData();

                if (this.weeklyChartInstance) {
                    this.weeklyChartInstance.destroy();
                }

                this.weeklyChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '% Complétion',
                            data: data,
                            backgroundColor: 'rgba(99, 102, 241, 0.6)', // Indigo-500 with opacity
                            borderColor: 'rgba(99, 102, 241, 1)', // Indigo-500
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            },

            renderRitualDistributionChart: function() {
                 const ctx = this.dom.ritualDistributionChartCanvas?.getContext('2d');
                 if (!ctx || typeof Chart === 'undefined') return;

                 const { labels, data, colors } = this.getRitualDistributionData();

                 if (this.distributionChartInstance) {
                     this.distributionChartInstance.destroy();
                 }

                 if (labels.length === 0) {
                     // Handle no active rituals case - maybe display a message
                      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                      ctx.font = "14px Arial";
                      ctx.fillStyle = "#6b7280"; // gray-500
                      ctx.textAlign = "center";
                      ctx.fillText("Aucun rituel actif à afficher.", ctx.canvas.width / 2, ctx.canvas.height / 2);
                     return;
                 }

                 this.distributionChartInstance = new Chart(ctx, {
                     type: 'doughnut',
                     data: {
                         labels: labels,
                         datasets: [{
                             label: 'Répartition',
                             data: data,
                             backgroundColor: colors,
                             hoverOffset: 4
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                             legend: {
                                 position: 'bottom',
                                 labels: { padding: 10 }
                             }
                         }
                     }
                 });
             },

            // --- Modals ---
            openModal: function(modalId) {
                const modal = document.getElementById(modalId);
                if(modal) modal.classList.remove('hidden');
            },

            closeModal: function(modalId) {
                const modal = document.getElementById(modalId);
                if(modal) modal.classList.add('hidden');
                if(modalId === 'rituals-confirmation-modal') this.confirmationCallback = null; // Clear callback
            },

            openAddRitualModal: function() {
                 // Reset fields before opening
                 if(this.dom.ritualNameInput) this.dom.ritualNameInput.value = '';
                 if(this.dom.ritualCategorySelect) this.dom.ritualCategorySelect.value = 'morning';
                 if(this.dom.ritualIconSelect) this.dom.ritualIconSelect.value = 'sun';
                 this.openModal('rituals-add-ritual-modal');
                 if(this.dom.ritualNameInput) this.dom.ritualNameInput.focus();
            },

             openConfirmationModal: function(title, message, isDanger = false) {
                 if (this.dom.confirmationTitle) this.dom.confirmationTitle.textContent = title;
                 if (this.dom.confirmationMessage) this.dom.confirmationMessage.textContent = message;
                 if (this.dom.confirmActionBtn) {
                     this.dom.confirmActionBtn.classList.toggle('bg-red-600', isDanger);
                     this.dom.confirmActionBtn.classList.toggle('hover:bg-red-700', isDanger);
                     this.dom.confirmActionBtn.classList.toggle('bg-indigo-600', !isDanger);
                     this.dom.confirmActionBtn.classList.toggle('hover:bg-indigo-700', !isDanger);
                 }
                 this.openModal('rituals-confirmation-modal');
             },

             executeConfirmation: function() {
                 if (typeof this.confirmationCallback === 'function') {
                     this.confirmationCallback.call(this); // Call the stored callback
                 }
                 this.closeModal('rituals-confirmation-modal');
             },

            openExportModal: function() {
                if (!this.dom.exportDataTextarea || !this.dom.aiPromptTextarea) return;
                const exportObj = {
                     rituals: this.rituals,
                     history: this.history,
                     settings: this.settings,
                     exportDate: new Date().toISOString()
                };
                const jsonData = JSON.stringify(exportObj, null, 2);
                 this.dom.exportDataTextarea.value = jsonData;

                 // Construct basic AI prompt
                 const aiPromptBase = `Voici mes données de suivi de rituels quotidiens au format JSON (rituels définis, historique de complétion jour par jour, et paramètres). Peux-tu analyser ces données pour identifier mes points forts, mes points faibles, mes tendances, et me donner des conseils personnalisés pour améliorer ma constance et l'efficacité de ma routine ?\n\nDonnées :\n\`\`\`json\n${jsonData}\n\`\`\``;
                 this.dom.aiPromptTextarea.value = aiPromptBase;

                 this.openModal('rituals-export-modal');
             },

             copyExportData: function() {
                 if (!this.dom.exportDataTextarea) return;
                 navigator.clipboard.writeText(this.dom.exportDataTextarea.value)
                     .then(() => this.showNotification("Données JSON copiées dans le presse-papiers."))
                     .catch(err => {
                         console.error("RitualsApp: Failed to copy export data", err);
                         this.showNotification("Erreur lors de la copie.", 'error');
                     });
             },

             submitToAI: function() {
                 if (!this.dom.aiPromptTextarea) return;
                 const promptText = this.dom.aiPromptTextarea.value;
                 navigator.clipboard.writeText(promptText)
                     .then(() => {
                         this.showNotification("Prompt pour IA copié ! Collez-le dans votre outil IA préféré (ex: ChatGPT, Claude).", 'info', 5000);
                         // Optionally, try to open a new tab with a generic AI link (less reliable)
                         // window.open('https://chat.openai.com', '_blank');
                     })
                     .catch(err => {
                         console.error("RitualsApp: Failed to copy AI prompt", err);
                         this.showNotification("Erreur lors de la copie du prompt.", 'error');
                     });
             },

            // --- Helpers ---
            getIconClass: function(iconKey) {
                 const iconMap = {
                     sun: 'fas fa-sun', coffee: 'fas fa-coffee', water: 'fas fa-tint', meditation: 'fas fa-om', book: 'fas fa-book-open', exercise: 'fas fa-dumbbell', journal: 'fas fa-pencil-alt', moon: 'fas fa-moon', list: 'fas fa-list-alt', utensils: 'fas fa-utensils', walking: 'fas fa-walking', bullseye: 'fas fa-bullseye', 'mobile-screen': 'fas fa-mobile-alt', spa: 'fas fa-spa', 'book-open': 'fas fa-book-reader', heart: 'fas fa-heart'
                 };
                 return iconMap[iconKey] || 'fas fa-check';
             },

             updateDateDisplay: function() {
                 if (this.dom.currentDateDisplay) {
                     this.dom.currentDateDisplay.textContent = this.currentDate.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                 }
             },

              updateStreakCount: function() {
                  if (this.dom.streakCountDisplay) {
                       const { streak } = this.calculateStats();
                       this.dom.streakCountDisplay.textContent = `${streak} jours de suite 🔥`;
                  }
             },

             showNotification: function(message, type = 'success', duration = 3000) {
                 // Reuse WheelApp's notification system or implement a simple one if needed
                 if (typeof WheelApp !== 'undefined' && WheelApp.showNotification) {
                     WheelApp.showNotification(message, duration); // Leverage existing system
                 } else {
                     // Fallback basic notification
                     console.log(`[RitualsApp Notification - ${type}]: ${message}`);
                     // Simple alert as fallback
                     // alert(`[${type.toUpperCase()}] ${message}`);
                 }
             }

        }; // End of RitualsApp


        // Initialize the main application on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            MainApp.init();
        });
    </script>

</body>
</html>
